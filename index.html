<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MoneyStack Architect</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' }
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        .card-pro { border-radius: 20px; transition: transform 0.2s; }
        .card-pro:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark-900 dark:text-gray-100 transition-colors duration-300 pb-24">

    <div class="bg-blue-600 dark:bg-blue-900 p-6 pb-12 rounded-b-[40px] shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
        
        <div class="flex justify-between items-start mb-4 relative z-10">
            <div>
                <h2 class="text-blue-100 text-sm font-medium">×”×•×Ÿ ×¢×¦××™ ×›×•×œ×œ</h2>
                <div class="text-4xl font-bold text-white flex items-baseline gap-1">
                    <span class="text-2xl">â‚ª</span>
                    <span id="netWorthDisplay">0</span>
                </div>
            </div>
            <button onclick="toggleTheme()" class="bg-white/20 p-2 rounded-full text-white hover:bg-white/30 transition">
                <i class="fa-solid fa-moon" id="themeIcon"></i>
            </button>
        </div>

        <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2 relative z-10">
            <div class="min-w-[100px] bg-white/10 p-3 rounded-2xl backdrop-blur-sm border border-white/10">
                <div class="text-xs text-blue-100">×¢×•"×© ×‘× ×§</div>
                <div class="font-bold text-white" id="bankDisplay">0</div>
            </div>
            <div class="min-w-[100px] bg-white/10 p-3 rounded-2xl backdrop-blur-sm border border-white/10">
                <div class="text-xs text-blue-100">×”×©×§×¢×•×ª</div>
                <div class="font-bold text-green-300" id="investDisplay">0</div>
            </div>
            <div class="min-w-[100px] bg-white/10 p-3 rounded-2xl backdrop-blur-sm border border-white/10">
                <div class="text-xs text-blue-100">××–×•××Ÿ</div>
                <div class="font-bold text-yellow-300" id="cashDisplay">0</div>
            </div>
        </div>
    </div>

    <div class="px-5 -mt-8 relative z-20 space-y-6">

        <div id="section-dashboard" class="view-section">
            <div class="bg-white dark:bg-dark-800 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-dark-700">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-blue-500"></i> × ×™×ª×•×— ×”×•×¦××•×ª
                </h3>
                <div class="h-48 relative">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <div class="mt-4 bg-white dark:bg-dark-800 p-5 rounded-3xl shadow-lg border border-gray-100 dark:border-dark-700">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-bullseye text-red-500"></i> ×”×™×¢×“×™× ×©×œ×™
                </h3>
                <div id="goalsContainer" class="space-y-4">
                    </div>
                <button onclick="addGoal()" class="mt-3 text-sm text-blue-500 font-medium">+ ×”×•×¡×£ ×™×¢×“ ×—×“×©</button>
            </div>
        </div>

        <div id="section-transactions" class="view-section hidden">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-lg dark:text-white">×ª× ×•×¢×•×ª ××—×¨×•× ×•×ª</h3>
                <button onclick="resetApp()" class="text-xs text-red-400">××™×¤×•×¡ × ×ª×•× ×™×</button>
            </div>
            <div id="txList" class="space-y-3 pb-20">
                </div>
        </div>

        <div id="section-add" class="view-section hidden">
            <h3 class="font-bold text-xl mb-4 dark:text-white">×¤×¢×•×œ×” ×—×“×©×”</h3>
            
            <div class="flex bg-gray-200 dark:bg-dark-700 p-1 rounded-xl mb-6">
                <button onclick="setAddMode('manual')" id="tab-manual" class="flex-1 py-2 rounded-lg font-bold bg-white dark:bg-dark-800 shadow-sm transition">×™×“× ×™</button>
                <button onclick="setAddMode('import')" id="tab-import" class="flex-1 py-2 rounded-lg font-bold text-gray-500 transition">×™×™×‘×•× ×‘× ×§</button>
            </div>

            <div id="form-manual" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setTxType('expense')" id="btn-expense" class="py-3 rounded-xl font-bold bg-red-500 text-white transition ring-2 ring-red-300">×”×•×¦××”</button>
                    <button onclick="setTxType('income')" id="btn-income" class="py-3 rounded-xl font-bold bg-gray-100 text-gray-500 dark:bg-dark-700 transition">×”×›× ×¡×”</button>
                </div>
                
                <input type="number" id="inpAmount" placeholder="×¡×›×•× (â‚ª)" class="w-full p-4 rounded-xl bg-white dark:bg-dark-800 border-none shadow-sm text-lg focus:ring-2 ring-blue-500 outline-none dark:text-white">
                <input type="text" id="inpDesc" placeholder="×ª×™××•×¨ (×œ××©×œ: ×“×œ×§)" class="w-full p-4 rounded-xl bg-white dark:bg-dark-800 border-none shadow-sm outline-none dark:text-white">
                
                <select id="inpCat" class="w-full p-4 rounded-xl bg-white dark:bg-dark-800 border-none shadow-sm outline-none dark:text-white">
                    <option value="×›×œ×œ×™">×§×˜×’×•×¨×™×”: ×›×œ×œ×™</option>
                    <option value="××–×•×Ÿ">ğŸ” ××•×›×œ ×•×¡×•×¤×¨</option>
                    <option value="×¨×›×‘">ğŸš— ×¨×›×‘ ×•×ª×—×‘×•×¨×”</option>
                    <option value="×‘×™×ª">ğŸ  ×—×©×‘×•× ×•×ª ×‘×™×ª</option>
                    <option value="×‘×™×œ×•×™×™×">ğŸº ×‘×™×œ×•×™×™×</option>
                    <option value="×”×©×§×¢×•×ª">ğŸ“ˆ ×”×¤×§×“×” ×œ×”×©×§×¢×•×ª</option>
                </select>

                <button onclick="saveManualTx()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition text-lg">×©××•×¨</button>
            </div>

            <div id="form-import" class="hidden space-y-4">
                <textarea id="importText" class="w-full h-40 p-4 rounded-xl bg-white dark:bg-dark-800 border-none shadow-sm text-sm font-mono dark:text-white" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”×©×•×¨×•×ª ××”×‘× ×§..."></textarea>
                <button onclick="processImport()" class="w-full bg-gray-800 dark:bg-gray-700 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition">× ×ª×— × ×ª×•× ×™×</button>
            </div>
        </div>

        <div id="section-assets" class="view-section hidden">
            <h3 class="font-bold text-xl mb-4 dark:text-white">× ×™×”×•×œ × ×›×¡×™×</h3>
            <div class="space-y-4">
                <div class="bg-white dark:bg-dark-800 p-4 rounded-2xl shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold dark:text-white">××–×•××Ÿ ×‘××¨× ×§</div>
                        <div class="text-xs text-gray-500">×¢×“×›×•×Ÿ ×™×“× ×™</div>
                    </div>
                    <input type="number" id="editCash" onchange="updateAssets()" class="w-24 text-left bg-gray-100 dark:bg-dark-700 p-2 rounded-lg font-bold" placeholder="0">
                </div>
                <div class="bg-white dark:bg-dark-800 p-4 rounded-2xl shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold dark:text-white">×ª×™×§ ×”×©×§×¢×•×ª</div>
                        <div class="text-xs text-gray-500">×©×•×•×™ × ×•×›×—×™</div>
                    </div>
                    <input type="number" id="editInvest" onchange="updateAssets()" class="w-24 text-left bg-gray-100 dark:bg-dark-700 p-2 rounded-lg font-bold" placeholder="0">
                </div>
            </div>
        </div>

    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-dark-800 border-t dark:border-dark-700 p-2 px-6 flex justify-between items-center pb-6 z-50">
        <button onclick="nav('dashboard')" id="nav-dashboard" class="text-blue-600 flex flex-col items-center">
            <i class="fa-solid fa-chart-line text-xl mb-1"></i>
        </button>
        <button onclick="nav('transactions')" id="nav-transactions" class="text-gray-400 flex flex-col items-center">
            <i class="fa-solid fa-list text-xl mb-1"></i>
        </button>
        <div class="relative -top-5">
            <button onclick="nav('add')" class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/40 active:scale-90 transition">
                <i class="fa-solid fa-plus text-2xl"></i>
            </button>
        </div>
        <button onclick="nav('assets')" id="nav-assets" class="text-gray-400 flex flex-col items-center">
            <i class="fa-solid fa-wallet text-xl mb-1"></i>
        </button>
        <button onclick="nav('settings')" class="text-gray-400 flex flex-col items-center">
            <i class="fa-solid fa-gear text-xl mb-1"></i>
        </button>
    </div>

    <script>
        // --- State Management ---
        let data = JSON.parse(localStorage.getItem('moneyStackPro')) || {
            transactions: [],
            assets: { cash: 0, investments: 0 },
            goals: [
                { id: 1, name: "×¤×’'×• 207", target: 15000, current: 3500, icon: "fa-car" },
                { id: 2, name: "×§×¨×Ÿ ×—×™×¨×•×", target: 20000, current: 5000, icon: "fa-shield-heart" }
            ],
            theme: 'light'
        };

        // --- Init ---
        let chartInstance = null;
        let txType = 'expense';
        
        // Theme Init
        if (data.theme === 'dark') document.documentElement.classList.add('dark');

        renderAll();

        // --- Core Functions ---
        function saveData() {
            localStorage.setItem('moneyStackPro', JSON.stringify(data));
            renderAll();
        }

        function renderAll() {
            // 1. Calculate Finances
            const bankBalance = data.transactions.reduce((sum, t) => sum + t.amount, 0);
            const totalNetWorth = bankBalance + (data.assets.cash || 0) + (data.assets.investments || 0);
            
            // 2. Update Header
            document.getElementById('netWorthDisplay').innerText = totalNetWorth.toLocaleString();
            document.getElementById('bankDisplay').innerText = bankBalance.toLocaleString() + ' â‚ª';
            document.getElementById('investDisplay').innerText = (data.assets.investments || 0).toLocaleString() + ' â‚ª';
            document.getElementById('cashDisplay').innerText = (data.assets.cash || 0).toLocaleString() + ' â‚ª';
            
            // 3. Update Inputs
            document.getElementById('editCash').value = data.assets.cash || '';
            document.getElementById('editInvest').value = data.assets.investments || '';

            // 4. Render Transactions
            const list = document.getElementById('txList');
            list.innerHTML = '';
            data.transactions.slice().reverse().forEach((tx, i) => {
                const isInc = tx.amount > 0;
                list.innerHTML += `
                    <div class="bg-white dark:bg-dark-800 p-4 rounded-2xl flex justify-between items-center shadow-sm card-pro">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${isInc ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                                <i class="fa-solid ${getIcon(tx.category)}"></i>
                            </div>
                            <div>
                                <div class="font-bold dark:text-white">${tx.desc}</div>
                                <div class="text-xs text-gray-500">${tx.date} â€¢ ${tx.category}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${isInc ? 'text-green-500' : 'text-gray-800 dark:text-gray-200'}" dir="ltr">
                                ${Math.abs(tx.amount).toLocaleString()}
                            </div>
                            <button onclick="delTx(${data.transactions.length - 1 - i})" class="text-xs text-red-300">××—×§</button>
                        </div>
                    </div>
                `;
            });

            // 5. Render Goals
            const goalsContainer = document.getElementById('goalsContainer');
            goalsContainer.innerHTML = '';
            data.goals.forEach(g => {
                const percent = Math.min(100, Math.round((g.current / g.target) * 100));
                goalsContainer.innerHTML += `
                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1 dark:text-gray-300">
                            <span><i class="fa-solid ${g.icon} mr-1"></i> ${g.name}</span>
                            <span>${percent}%</span>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-dark-900 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
                        </div>
                        <div class="text-xs text-right text-gray-400 mt-1">${g.current.toLocaleString()} / ${g.target.toLocaleString()}</div>
                    </div>
                `;
            });

            // 6. Render Chart
            renderChart();
        }

        // --- Chart Logic ---
        function renderChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // Group expenses by category
            const cats = {};
            data.transactions.filter(t => t.amount < 0).forEach(t => {
                cats[t.category] = (cats[t.category] || 0) + Math.abs(t.amount);
            });

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: data.theme==='dark'?'#fff':'#333' } } }
                }
            });
        }

        // --- Logic: Add Transaction ---
        function setTxType(type) {
            txType = type;
            const expenseBtn = document.getElementById('btn-expense');
            const incomeBtn = document.getElementById('btn-income');
            
            if (type === 'expense') {
                expenseBtn.className = 'py-3 rounded-xl font-bold bg-red-500 text-white transition ring-2 ring-red-300 shadow-lg';
                incomeBtn.className = 'py-3 rounded-xl font-bold bg-gray-100 text-gray-500 dark:bg-dark-700 transition';
            } else {
                expenseBtn.className = 'py-3 rounded-xl font-bold bg-gray-100 text-gray-500 dark:bg-dark-700 transition';
                incomeBtn.className = 'py-3 rounded-xl font-bold bg-green-500 text-white transition ring-2 ring-green-300 shadow-lg';
            }
        }

        function saveManualTx() {
            const amt = parseFloat(document.getElementById('inpAmount').value);
            const desc = document.getElementById('inpDesc').value;
            const cat = document.getElementById('inpCat').value;
            
            if (!amt || !desc) return alert('×—×¡×¨ ×¡×›×•× ××• ×ª×™××•×¨');
            
            const finalAmt = txType === 'expense' ? -amt : amt;
            
            data.transactions.push({
                date: new Date().toLocaleDateString('he-IL'),
                desc: desc,
                amount: finalAmt,
                category: cat
            });
            
            saveData();
            document.getElementById('inpAmount').value = '';
            document.getElementById('inpDesc').value = '';
            alert('× ×©××¨ ×‘×”×¦×œ×—×”');
            nav('dashboard');
        }

        // --- Logic: Import Parser (Auto Categorize) ---
        function processImport() {
            const text = document.getElementById('importText').value;
            const lines = text.split('\n');
            let added = 0;

            lines.forEach(line => {
                if (line.match(/\d/) && (line.includes('|') || line.includes('/'))) {
                    let parts = line.includes('|') ? line.split('|') : line.split(/\s\s+/);
                    parts = parts.map(p => p.trim());
                    
                    if (parts.length >= 3) {
                        const expense = cleanNum(parts[2]); // Assuming col 3 is expense
                        const income = cleanNum(parts[3]);  // Assuming col 4 is income
                        const desc = parts[1] || '×‘× ×§';
                        const date = parts[0];
                        
                        let amount = 0;
                        if (expense > 0) amount = -expense;
                        if (income > 0) amount = income;

                        if (amount !== 0) {
                            // Auto Categorize Logic
                            let cat = '×›×œ×œ×™';
                            if (desc.includes('××§×¡') || desc.includes('×›××œ') || desc.includes('×™×©×¨××›×¨×˜')) cat = '××©×¨××™';
                            else if (desc.includes('×¤×™×™×‘×•×§×¡') || desc.includes('×‘×™×˜')) cat = '×”×¢×‘×¨×•×ª';
                            else if (desc.includes('××•×©×¨ ×¢×“') || desc.includes('×©×•×¤×¨×¡×œ')) cat = '××–×•×Ÿ';
                            else if (desc.includes('×“×œ×§') || desc.includes('×¤× ×’×•')) cat = '×¨×›×‘';

                            data.transactions.push({ date, desc, amount, category: cat });
                            added++;
                        }
                    }
                }
            });

            if (added > 0) {
                saveData();
                alert(`× ×•×¡×¤×• ${added} ×ª× ×•×¢×•×ª!`);
                document.getElementById('importText').value = '';
                nav('dashboard');
            } else {
                alert('×œ× ×–×•×”×• × ×ª×•× ×™×.');
            }
        }

        // --- Utilities ---
        function nav(view) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            
            const mapping = {
                'dashboard': 'section-dashboard',
                'transactions': 'section-transactions',
                'add': 'section-add',
                'assets': 'section-assets',
                'settings': 'section-dashboard' // Placeholder
            };
            
            document.getElementById(mapping[view]).classList.remove('hidden');
            
            // Reset nav colors
            ['dashboard','transactions','assets'].forEach(n => {
                document.getElementById('nav-'+n).classList.remove('text-blue-600');
                document.getElementById('nav-'+n).classList.add('text-gray-400');
            });
            
            if(document.getElementById('nav-'+view)) {
                document.getElementById('nav-'+view).classList.remove('text-gray-400');
                document.getElementById('nav-'+view).classList.add('text-blue-600');
            }
        }

        function setAddMode(mode) {
            document.getElementById('form-manual').classList.add('hidden');
            document.getElementById('form-import').classList.add('hidden');
            document.getElementById('form-'+mode).classList.remove('hidden');
            
            document.getElementById('tab-manual').classList.toggle('bg-white', mode === 'manual');
            document.getElementById('tab-manual').classList.toggle('text-gray-500', mode !== 'manual');
            document.getElementById('tab-import').classList.toggle('bg-white', mode === 'import');
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                data.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                data.theme = 'dark';
            }
            saveData();
        }

        function updateAssets() {
            data.assets.cash = parseFloat(document.getElementById('editCash').value) || 0;
            data.assets.investments = parseFloat(document.getElementById('editInvest').value) || 0;
            saveData();
        }

        function delTx(index) {
            if(confirm('×œ××—×•×§?')) {
                data.transactions.splice(index, 1);
                saveData();
            }
        }

        function resetApp() {
            if(confirm('×œ××—×•×§ ×”×›×œ ×•×œ×”×ª×—×™×œ ×××¤×¡?')) {
                data.transactions = [];
                saveData();
            }
        }

        function cleanNum(str) {
            if (!str || str === '---') return 0;
            return parseFloat(str.replace(/,/g, ''));
        }

        function getIcon(cat) {
            const map = {
                '××–×•×Ÿ': 'fa-burger',
                '×¨×›×‘': 'fa-car',
                '×‘×™×ª': 'fa-house',
                '×‘×™×œ×•×™×™×': 'fa-beer-mug-empty',
                '××©×¨××™': 'fa-credit-card',
                '×”×©×§×¢×•×ª': 'fa-chart-line',
                '×›×œ×œ×™': 'fa-bag-shopping'
            };
            return map[cat] || 'fa-circle-dollar-to-slot';
        }

    </script>
</body>
</html>
