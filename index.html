<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>YoniOS Native</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* 注爪  - 拽 专 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a;
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 驻转专 驻住 */
        .reset-btn {
            position: fixed; top: 10px; left: 10px; 
            background: rgba(255,0,0,0.2); border: 1px solid red; color: red;
            padding: 5px 10px; font-size: 10px; border-radius: 5px; z-index: 10000;
        }

        /* 住 */
        #loading-screen, #login-screen, #app-screen {
            position: absolute; inset: 0; background: #0f172a;
            display: flex; flex-direction: column; align-items: center; 
            transition: opacity 0.3s;
        }
        
        #loading-screen { z-index: 50; justify-content: center; }
        #login-screen { z-index: 40; justify-content: center; padding: 20px; }
        #app-screen { z-index: 30; }

        /* 专 */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 10px;
        }

        input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
            outline: none;
            box-sizing: border-box; /* 砖! */
        }

        button.primary {
            background: linear-gradient(45deg, #2563eb, #4f46e5);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            width: 100%;
            font-size: 16px;
        }

        /* 转 驻拽爪 */
        header {
            width: 100%; padding: 40px 20px 10px 20px;
            background: rgba(15, 23, 42, 0.9);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }

        main {
            flex: 1; width: 100%; overflow-y: auto; padding: 20px; padding-bottom: 100px;
        }

        .task-item {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 15px; border-radius: 12px; margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .checkbox {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid #666; display: flex; align-items: center; justify-content: center;
        }
        .checkbox.checked { background: #22c55e; border-color: #22c55e; }

        /* 转驻专 转转 */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px; border-radius: 20px;
            display: flex; justify-content: space-around;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-btn { font-size: 20px; color: #666; background: none; border: none; }
        .nav-btn.active { color: white; }

        .fab {
            position: fixed; bottom: 90px; left: 20px;
            width: 55px; height: 55px;
            background: #2563eb; border-radius: 15px;
            color: white; font-size: 24px; border: none;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            display: flex; align-items: center; justify-content: center;
        }

        /*  */
        #modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 100; display: none; align-items: flex-end;
        }
        #modal.open { display: flex; }
        .modal-content {
            background: #1e293b; width: 100%; border-radius: 20px 20px 0 0;
            padding: 30px; border-top: 1px solid rgba(255,255,255,0.2);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <button class="reset-btn" onclick="localStorage.clear(); location.reload()">RESET</button>

    <div id="loading-screen">
        <div style="font-size: 50px; margin-bottom: 20px;"></div>
        <div>注 注...</div>
        <div id="error-msg" style="color: red; font-size: 12px; margin-top: 10px;"></div>
    </div>

    <div id="login-screen" class="hidden">
        <h1 style="font-size: 40px; font-weight: 900; margin-bottom: 10px;">YoniOS</h1>
        <p style="color: #aaa; margin-bottom: 40px;">专住转 Native 专</p>
        <input type="text" id="login-name" placeholder="砖">
        <input type="email" id="login-email" placeholder="">
        <button class="primary" onclick="handleLogin()">住</button>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <div>
                <h2 id="user-name-display" style="margin: 0; font-size: 20px;">User</h2>
                <div id="save-status" style="font-size: 10px; color: #4ade80;">专</div>
            </div>
            <div class="glass" style="padding: 5px 15px; font-weight: bold;">
                <span id="coins-display">0</span> 
            </div>
        </header>

        <main id="main-content">
            </main>

        <button class="fab" onclick="openModal()">+</button>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="renderTasks()" id="btn-tasks"><i class="fa-solid fa-list-check"></i></button>
            <button class="nav-btn" onclick="renderShop()" id="btn-shop"><i class="fa-solid fa-store"></i></button>
            <button class="nav-btn" onclick="renderProfile()" id="btn-profile"><i class="fa-solid fa-user"></i></button>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0; margin-bottom: 20px;">住驻</h3>
            <input type="text" id="new-item-title" placeholder="转专转">
            <input type="number" id="new-item-value" placeholder="注专 / 拽">
            <button class="primary" onclick="saveNewItem()">砖专</button>
            <button onclick="closeModal()" style="width: 100%; background: none; border: none; color: #aaa; padding: 15px; margin-top: 10px;"></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAMBx4Udu3w9iR6GpEcl561TNWGRc1UVQ0",
            authDomain: "yoni-os.firebaseapp.com",
            databaseURL: "https://yoni-os-default-rtdb.firebaseio.com",
            projectId: "yoni-os",
            storageBucket: "yoni-os.firebasestorage.app",
            messagingSenderId: "238428366388",
            appId: "1:238428366388:web:70e54810382d3d88134c61"
        };

        // 砖转 
        let db, userRef;
        let state = {
            user: null,
            coins: 0,
            tasks: [],
            shopItems: [],
            tab: 'tasks'
        };

        // 转
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            checkAuth();
        } catch (e) {
            document.getElementById('error-msg').innerText = "砖转 专: " + e.message;
        }

        function checkAuth() {
            const saved = localStorage.getItem('yoni_native_user');
            if (saved) {
                const userData = JSON.parse(saved);
                startApp(userData.name, userData.email);
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        // 砖驻转 驻拽爪转 -HTML
        window.handleLogin = function() {
            const name = document.getElementById('login-name').value;
            const email = document.getElementById('login-email').value;
            if(name && email) {
                localStorage.setItem('yoni_native_user', JSON.stringify({name, email}));
                startApp(name, email);
            }
        };

        function startApp(name, email) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');

            const safeEmail = email.toLowerCase().replace(/\./g, '_').replace(/@/g, '_at_');
            userRef = ref(db, 'users/' + safeEmail);

            //  砖
            onValue(userRef, (snapshot) => {
                const val = snapshot.val();
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');

                state.user = { name, email };
                
                if (val) {
                    state.coins = val.coins || 0;
                    state.tasks = val.tasks ? Object.values(val.tasks) : [];
                    state.shopItems = val.shopItems ? Object.values(val.shopItems) : [];
                }
                
                updateUI();
            }, (error) => {
                document.getElementById('error-msg').innerText = "砖转 专砖. 住 抓 RESET";
            });
        }

        function updateUI() {
            document.getElementById('user-name-display').innerText = state.user.name;
            document.getElementById('coins-display').innerText = state.coins;
            
            if(state.tab === 'tasks') renderTasks();
            else if(state.tab === 'shop') renderShop();
            else renderProfile();
        }

        // 专专 住 (Native DOM Manipulation)
        window.renderTasks = function() {
            state.tab = 'tasks';
            updateNav();
            const main = document.getElementById('main-content');
            
            // : 爪注 住祝
            const sortedTasks = [...state.tasks].sort((a,b) => a.completed - b.completed);

            let html = `<h3 style="color:#94a3b8; font-size:12px; margin-bottom:10px;">砖转 (${state.tasks.length})</h3>`;
            
            if(sortedTasks.length === 0) html += `<div style="text-align:center; color:#555; margin-top:50px;"> 砖转</div>`;

            sortedTasks.forEach((task, index) => {
                // 爪转 拽住 拽专 注专 专砖  砖 注专
                const realIndex = state.tasks.findIndex(t => t.title === task.title); 
                
                html += `
                <div class="task-item" style="opacity: ${task.completed ? 0.5 : 1}">
                    <div onclick="toggleTask(${realIndex})" class="checkbox ${task.completed ? 'checked' : ''}">
                        ${task.completed ? '<i class="fa-solid fa-check" style="font-size:12px;"></i>' : ''}
                    </div>
                    <div style="flex:1">
                        <div style="font-weight:bold; ${task.completed ? 'text-decoration:line-through' : ''}">${task.title}</div>
                        <div style="font-size:12px; color:#60a5fa;">+${task.reward} XP</div>
                    </div>
                    <div onclick="deleteTask(${realIndex})" style="color:#666;"><i class="fa-solid fa-trash"></i></div>
                </div>`;
            });
            
            // 驻转专 拽
            if(state.tasks.some(t => t.completed)) {
                html += `<button onclick="clearCompleted()" style="width:100%; padding:10px; background:rgba(255,0,0,0.1); color:#f87171; border:none; border-radius:8px; margin-top:10px;">拽 砖转 砖爪注</button>`;
            }

            main.innerHTML = html;
        };

        window.renderShop = function() {
            state.tab = 'shop';
            updateNav();
            const main = document.getElementById('main-content');
            let html = `<h3 style="color:#94a3b8; font-size:12px; margin-bottom:10px;">转</h3><div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">`;
            
            state.shopItems.forEach((item, index) => {
                html += `
                <div class="glass" style="text-align:center; position:relative;">
                    <div onclick="deleteShopItem(${index})" style="position:absolute; top:5px; left:5px; color:#666;"><i class="fa-solid fa-times"></i></div>
                    <div style="font-size:30px; margin-bottom:5px;"></div>
                    <div style="font-weight:bold;">${item.name}</div>
                    <div style="font-size:12px; color:#60a5fa; margin-bottom:10px;">${item.cost} </div>
                    <button onclick="buyItem(${index})" style="background:white; color:black; border:none; padding:5px 10px; border-radius:5px; width:100%; font-weight:bold; font-size:12px;">专砖</button>
                </div>`;
            });
            html += `</div>`;
            main.innerHTML = html;
        };

        window.renderProfile = function() {
            state.tab = 'profile';
            updateNav();
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <div style="text-align:center; margin-top:50px;">
                    <div style="font-size:50px; margin-bottom:10px;"></div>
                    <h2>${state.user.name}</h2>
                    <p style="color:#aaa;">${state.user.email}</p>
                    <button onclick="doLogout()" style="background:rgba(255,0,0,0.2); border:1px solid red; color:red; padding:10px 30px; border-radius:10px; margin-top:20px;">转转拽</button>
                </div>
            `;
        };

        function updateNav() {
            document.getElementById('btn-tasks').className = `nav-btn ${state.tab === 'tasks' ? 'active' : ''}`;
            document.getElementById('btn-shop').className = `nav-btn ${state.tab === 'shop' ? 'active' : ''}`;
            document.getElementById('btn-profile').className = `nav-btn ${state.tab === 'profile' ? 'active' : ''}`;
        }

        // 驻注转 转
        window.toggleTask = function(index) {
            const task = state.tasks[index];
            task.completed = !task.completed;
            if(task.completed) {
                state.coins += parseInt(task.reward);
                try { confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } }); } catch(e){}
            } else {
                state.coins -= parseInt(task.reward);
            }
            saveData();
        };

        window.deleteTask = function(index) {
            if(confirm('拽?')) {
                state.tasks.splice(index, 1);
                saveData();
            }
        };
        
        window.deleteShopItem = function(index) {
             if(confirm('拽?')) {
                state.shopItems.splice(index, 1);
                saveData();
            }
        };

        window.clearCompleted = function() {
            if(confirm('拽转 ?')) {
                state.tasks = state.tasks.filter(t => !t.completed);
                saveData();
            }
        }

        window.buyItem = function(index) {
            const item = state.shopItems[index];
            if(state.coins >= item.cost) {
                if(confirm('拽转?')) {
                    state.coins -= item.cost;
                    try { confetti(); } catch(e){}
                    saveData();
                }
            } else {
                alert('住专 住祝');
            }
        };

        // 
        window.openModal = function() { document.getElementById('modal').classList.add('open'); };
        window.closeModal = function() { document.getElementById('modal').classList.remove('open'); };

        window.saveNewItem = function() {
            const title = document.getElementById('new-item-title').value;
            const val = document.getElementById('new-item-value').value;
            
            if(title) {
                if(state.tab === 'shop') {
                    state.shopItems.push({ name: title, cost: parseInt(val)||100 });
                } else {
                    state.tasks.push({ title: title, reward: parseInt(val)||10, completed: false });
                }
                saveData();
                closeModal();
                // 驻住 砖转
                document.getElementById('new-item-title').value = '';
                document.getElementById('new-item-value').value = '';
            }
        };

        window.doLogout = function() {
            if(confirm('转转拽?')) {
                localStorage.removeItem('yoni_native_user');
                location.reload();
            }
        };

        function saveData() {
            if(!userRef) return;
            document.getElementById('save-status').innerText = '砖专...';
            document.getElementById('save-status').style.color = 'orange';
            
            set(userRef, {
                coins: state.coins,
                tasks: state.tasks,
                shopItems: state.shopItems
            }).then(() => {
                document.getElementById('save-status').innerText = '专';
                document.getElementById('save-status').style.color = '#4ade80';
                updateUI(); // 专注 住
            });
        }

    </script>
</body>
</html>
