<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MoneyStack 9.2 (PIN 1234)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { sans: ['Rubik', 'sans-serif'] }, colors: { primary: '#3b82f6', secondary: '#64748b' } } } }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(226, 232, 240, 0.8); }
        .dark .glass-panel { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(51, 65, 85, 0.8); }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .budget-track { background-color: #e2e8f0; height: 10px; border-radius: 99px; overflow: hidden; }
        .budget-fill { height: 100%; transition: width 1s ease-in-out; }
        #pinOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .pin-dot { w-4 h-4 rounded-full border-2 border-white/50 transition: all 0.2s; }
        .pin-dot.filled { background: white; border-color: white; transform: scale(1.2); }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-10px);} 75% {transform: translateX(10px);} }
    </style>
</head>
<body class="text-slate-800 dark:bg-slate-900 dark:text-slate-100 pb-28 transition-colors duration-300">
        <div id="pinOverlay"> <div class="text-3xl font-bold mb-4"><i class="fa-solid fa-shield-halved text-blue-500 mb-2"></i><br>MoneyStack</div>
        <p class="mb-2 opacity-70">הכנס קוד סודי</p>
        <p class="mb-6 text-green-400 font-bold text-xl tracking-widest">CODE: 1234</p>
        <div class="flex gap-4 mb-8">
            <div class="w-4 h-4 rounded-full border-2 border-white/30 pin-dot" id="dot1"></div>
            <div class="w-4 h-4 rounded-full border-2 border-white/30 pin-dot" id="dot2"></div>
            <div class="w-4 h-4 rounded-full border-2 border-white/30 pin-dot" id="dot3"></div>
            <div class="w-4 h-4 rounded-full border-2 border-white/30 pin-dot" id="dot4"></div>
        </div>
        <div class="grid grid-cols-3 gap-6 text-2xl font-bold">
            <button onclick="typePin(1)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">1</button>
            <button onclick="typePin(2)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">2</button>
            <button onclick="typePin(3)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">3</button>
            <button onclick="typePin(4)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">4</button>
            <button onclick="typePin(5)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">5</button>
            <button onclick="typePin(6)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">6</button>
            <button onclick="typePin(7)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">7</button>
            <button onclick="typePin(8)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">8</button>
            <button onclick="typePin(9)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">9</button>
            <div></div>
            <button onclick="typePin(0)" class="w-16 h-16 rounded-full bg-white/10 active:bg-white/30 flex items-center justify-center">0</button>
            <button onclick="backspacePin()" class="w-16 h-16 flex items-center justify-center text-red-400"><i class="fa-solid fa-delete-left"></i></button>
        </div>
    </div>

    <header class="bg-blue-600 dark:bg-blue-900 text-white p-6 pt-8 rounded-b-[35px] shadow-2xl relative overflow-hidden z-10">
        <div class="flex justify-between items-start mb-4">
            <div class="bg-white/10 px-3 py-1 rounded-full backdrop-blur-md border border-white/10">
                <span class="text-xs font-mono tracking-wider" id="liveClock">--:--</span>
            </div>
            <button onclick="nav('settings')" class="bg-white/10 w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-md"><i class="fa-solid fa-gear text-xs"></i></button>
        </div>
        <div class="text-center mb-6">
             <p class="text-blue-100 text-sm mb-1">שווי נקי מוערך</p>
             <h1 class="text-4xl font-bold tracking-tight">₪<span id="totalNetWorth">0</span></h1>
        </div>
        <div class="grid grid-cols-3 gap-3">
            <button onclick="openDrillDown('bank')" class="bg-white/10 active:bg-white/20 backdrop-blur-md p-3 rounded-2xl border border-white/10 text-center transition"><div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-building-columns text-sm"></i></div><p class="text-[10px] text-blue-100 mb-0.5">עו"ש</p><p class="font-bold text-sm" id="statBank">0</p></button>
            <button onclick="openDrillDown('credit')" class="bg-white/10 active:bg-white/20 backdrop-blur-md p-3 rounded-2xl border border-white/10 text-center transition"><div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-credit-card text-sm"></i></div><p class="text-[10px] text-blue-100 mb-0.5">אשראי</p><p class="font-bold text-sm text-red-200" id="statCredit">0</p></button>
            <button onclick="openDrillDown('assets')" class="bg-white/10 active:bg-white/20 backdrop-blur-md p-3 rounded-2xl border border-white/10 text-center transition"><div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fa-solid fa-piggy-bank text-sm"></i></div><p class="text-[10px] text-blue-100 mb-0.5">נכסים</p><p class="font-bold text-sm text-emerald-200" id="statAssets">0</p></button>
        </div>
    </header>
        <main class="px-4 -mt-4 relative z-20 space-y-5">
        <div id="view-dashboard" class="view-section slide-up">
            <div class="flex gap-3 mb-4 overflow-x-auto pb-1 no-scrollbar">
                <button onclick="nav('add')" class="flex-none bg-blue-600 text-white px-5 py-3 rounded-full text-xs font-bold shadow-lg shadow-blue-500/30 flex items-center gap-2"><i class="fa-solid fa-plus"></i> הוספה</button>
                <button onclick="openDrillDown('budget')" class="flex-none bg-white dark:bg-slate-800 px-5 py-3 rounded-full text-xs font-bold shadow-sm border border-slate-100 dark:border-slate-700 text-slate-500"><i class="fa-solid fa-chart-pie"></i> תקציב</button>
                <button onclick="openDrillDown('credit')" class="flex-none bg-white dark:bg-slate-800 px-5 py-3 rounded-full text-xs font-bold shadow-sm border border-slate-100 dark:border-slate-700 text-slate-500"><i class="fa-solid fa-credit-card"></i> כרטיסים</button>
            </div>
            <div class="glass-panel p-5 rounded-3xl shadow-sm bg-white dark:bg-slate-800 mb-4" id="budgetWidget">
                <h3 class="font-bold text-sm text-slate-700 dark:text-slate-200 mb-3">מצב תקציב חודשי</h3>
                <div id="dashboardBudgets" class="space-y-3"></div>
            </div>
            <div class="glass-panel p-5 rounded-3xl shadow-sm bg-white dark:bg-slate-800">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-sm text-slate-700 dark:text-slate-200">פעולות אחרונות</h3>
                    <button onclick="nav('transactions')" class="text-xs text-blue-500 font-medium">לכל הפעולות</button>
                </div>
                <div id="recentTxList" class="space-y-4"></div>
            </div>
        </div>

        <div id="view-add" class="view-section hidden slide-up">
            <h2 class="text-xl font-bold mb-4 px-2">תנועה חדשה</h2>
            <div class="glass-panel p-5 rounded-3xl bg-white dark:bg-slate-800 shadow-xl space-y-4">
                <div class="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-xl">
                    <button onclick="setFormType('expense')" id="btn-exp" class="flex-1 py-3 rounded-lg font-bold text-sm bg-white shadow text-red-500 transition">הוצאה</button>
                    <button onclick="setFormType('income')" id="btn-inc" class="flex-1 py-3 rounded-lg font-bold text-sm text-slate-400 transition">הכנסה</button>
                </div>
                <div class="space-y-4">
                    <div class="relative"><label class="text-[10px] font-bold text-slate-400 absolute -top-2 right-2 bg-white dark:bg-slate-800 px-1">סכום (₪)</label><input type="number" id="inpAmount" class="w-full text-3xl font-bold bg-transparent border border-slate-200 dark:border-slate-700 rounded-xl p-4 outline-none focus:border-blue-500 transition text-center" placeholder="0.00"></div>
                    <div class="relative"><label class="text-[10px] font-bold text-slate-400 absolute -top-2 right-2 bg-white dark:bg-slate-800 px-1">תיאור</label><input type="text" id="inpDesc" list="descOptions" class="w-full bg-slate-50 dark:bg-slate-900 border border-transparent focus:bg-white focus:border-blue-500 rounded-xl p-3 outline-none transition text-sm" placeholder="התחל להקליד..."><datalist id="descOptions"></datalist></div>
                </div>
                <div id="methodSelectorDiv"><label class="text-xs font-bold text-slate-400 mb-2 block" id="methodLabel">מקור הכסף</label><div class="flex gap-2 overflow-x-auto no-scrollbar pb-2" id="paymentMethodsList"></div><input type="hidden" id="selectedMethod" value="bank"></div>
                <div><label class="text-xs font-bold text-slate-400 mb-2 block">קטגוריה</label><div class="flex flex-wrap gap-2" id="categoryChips"></div><input type="hidden" id="selectedCat" value="כללי"></div>
                <button onclick="saveTransaction()" id="saveBtn" class="w-full bg-red-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-red-500/30 active:scale-95 transition mt-2">רשום הוצאה</button>
            </div>
        </div>
                <div id="view-transactions" class="view-section hidden slide-up">
            <h2 class="text-xl font-bold mb-4 px-2">יומן תנועות</h2>
            <div class="bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm mb-4 space-y-3 sticky top-0 z-30">
                <div class="relative"><i class="fa-solid fa-magnifying-glass absolute top-3 right-3 text-slate-400 text-sm"></i><input type="text" id="searchDesc" onkeyup="renderTransactions()" placeholder="חפש לפי שם..." class="w-full bg-slate-50 dark:bg-slate-900 pr-9 p-2.5 rounded-xl text-sm border-none outline-none focus:ring-2 ring-blue-500"></div>
            </div>
            <div id="fullTxList" class="space-y-2 pb-20"></div>
        </div>

        <div id="view-settings" class="view-section hidden slide-up">
            <h2 class="text-2xl font-bold mb-6 px-2">הגדרות</h2>
            <div class="mb-6 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-900">
                <h3 class="text-xs font-bold text-blue-500 mb-3 px-1 uppercase tracking-wider">גיבוי ואבטחה</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="downloadBackup()" class="bg-white dark:bg-slate-800 py-3 rounded-xl shadow-sm text-sm font-bold text-blue-600 border border-blue-100 dark:border-slate-700"><i class="fa-solid fa-download mb-1 block text-lg"></i> שמור גיבוי</button>
                    <button onclick="document.getElementById('restoreFile').click()" class="bg-white dark:bg-slate-800 py-3 rounded-xl shadow-sm text-sm font-bold text-slate-600 border border-slate-200 dark:border-slate-700"><i class="fa-solid fa-upload mb-1 block text-lg"></i> שחזר נתונים</button>
                    <input type="file" id="restoreFile" class="hidden" onchange="restoreBackup(this)">
                </div>
                <div class="mt-3 flex items-center justify-between bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                    <span class="text-sm font-bold">קוד סודי (1234)</span>
                    <button onclick="togglePinSetup()" id="pinStatusBtn" class="text-xs bg-slate-100 px-3 py-1 rounded-full text-slate-500">כבוי</button>
                </div>
            </div>
            <div class="mb-6">
                <h3 class="text-xs font-bold text-slate-400 mb-3 px-2 uppercase tracking-wider">פרופיל אישי</h3>
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-slate-100 dark:border-slate-700 space-y-3">
                    <input type="text" id="set-name" class="w-full bg-slate-50 dark:bg-slate-900 p-2 rounded-lg text-sm outline-none" placeholder="שם מלא" onchange="saveProfile()">
                    <div class="flex gap-3"><input type="text" id="set-branch" class="flex-1 bg-slate-50 dark:bg-slate-900 p-2 rounded-lg text-sm outline-none" placeholder="בנק/סניף" onchange="saveProfile()"><input type="text" id="set-account" class="flex-1 bg-slate-50 dark:bg-slate-900 p-2 rounded-lg text-sm outline-none" placeholder="חשבון" onchange="saveProfile()"></div>
                </div>
            </div>
            <div class="mb-6"><button onclick="resetData()" class="w-full p-4 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-xl font-bold text-sm flex items-center justify-center gap-2"><i class="fa-solid fa-trash"></i> איפוס נתונים</button></div>
        </div>

        <div id="drillDownModal" class="hidden fixed inset-0 bg-slate-100 dark:bg-slate-900 z-50 p-4 overflow-y-auto pb-20">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-slate-100 dark:bg-slate-900 py-2 z-10">
                <h2 class="text-2xl font-bold" id="ddTitle">כותרת</h2>
                <button onclick="closeDrillDown()" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="ddContent" class="space-y-4"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-t dark:border-slate-800 p-2 pb-6 flex justify-around items-end z-40">
        <button onclick="nav('dashboard')" id="nav-dashboard" class="text-blue-600 flex flex-col items-center w-16"><i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[10px]">בית</span></button>
        <button onclick="nav('transactions')" id="nav-transactions" class="text-slate-400 flex flex-col items-center w-16"><i class="fa-solid fa-list-ul text-xl mb-1"></i><span class="text-[10px]">יומן</span></button>
        <div class="relative -top-6"><button onclick="nav('add')" class="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/40 active:scale-90 transition transform hover:-translate-y-1"><i class="fa-solid fa-plus text-2xl"></i></button></div>
        <button onclick="nav('settings')" id="nav-settings" class="text-slate-400 flex flex-col items-center w-16"><i class="fa-solid fa-gear text-xl mb-1"></i><span class="text-[10px]">הגדרות</span></button>
    </nav>
        <script>
        const initialData = { txs: [], cards: [{ id: 'c1', name: 'מקס', limit: 20000, used: 0, day: 10 }], assets: [{ id: 'a1', name: 'חיסכון נזיל', amount: 0, type: 'saving' }], budgets: {}, profile: { name: 'אורח', account: '', branch: '' }, pin: null, theme: 'light', catsExp: ['מזון', 'רכב', 'בית', 'בילויים', 'קניות', 'חשבונות'], catsInc: ['משכורת', 'הפקדה', 'ביט', 'העברה', 'מתנה'] };
        let app = JSON.parse(localStorage.getItem('moneyAppV9')) || JSON.parse(localStorage.getItem('moneyAppV8')) || initialData;
        if(!app.budgets) app.budgets = {}; 
        let formMode = 'expense', currentPin = "";

        init();

        function init() {
            // Force PIN to 1234
            app.pin = "1234";
            save(); 

            if(app.theme === 'dark') document.documentElement.classList.add('dark');
            setInterval(updateClock, 1000); updateClock();
            document.getElementById('pinOverlay').classList.remove('hidden');
            loadProfile(); updatePinStatus(); renderDashboard(); updateDataList();
        }
        function save() { localStorage.setItem('moneyAppV9', JSON.stringify(app)); renderDashboard(); updateDataList(); }
        
        // PIN Functions
        function typePin(num) { if(currentPin.length < 4) { currentPin += num; updateDots(); if(currentPin.length === 4) checkPin(); } }
        function backspacePin() { currentPin = currentPin.slice(0, -1); updateDots(); }
        function updateDots() { for(let i=1; i<=4; i++) { const dot = document.getElementById('dot'+i); if(i <= currentPin.length) dot.classList.add('filled'); else dot.classList.remove('filled'); } }
        function checkPin() {
            // הקוד כאן 1234
            if(currentPin === "1234") { document.getElementById('pinOverlay').classList.add('hidden'); currentPin = ""; updateDots(); }
            else { alert('קוד שגוי (הקוד הוא 1234)'); currentPin = ""; updateDots(); document.getElementById('pinOverlay').classList.add('shake'); setTimeout(()=>document.getElementById('pinOverlay').classList.remove('shake'), 500); }
        }
        function togglePinSetup() {
            // תמיד פעיל בגרסה הזו
            alert('הקוד קבוע בגרסה זו: 1234');
        }
        function updatePinStatus() { const btn = document.getElementById('pinStatusBtn'); btn.innerText = "פעיל (1234)"; btn.classList.replace('text-slate-500','text-green-600'); btn.classList.replace('bg-slate-100','bg-green-100'); }

        // Backup
        function downloadBackup() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app)); const a = document.createElement('a'); a.setAttribute("href", dataStr); a.setAttribute("download", "money_backup.json"); document.body.appendChild(a); a.click(); a.remove(); }
        function restoreBackup(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const loaded = JSON.parse(e.target.result); if(confirm('לשחזר נתונים? הקיים יימחק.')) { app = loaded; save(); location.reload(); } } catch(err) { alert('קובץ שגוי'); } }; reader.readAsText(file); }

        // Logic
        function renderDashboard() {
            const bank = app.txs.reduce((s, t) => t.method==='bank' ? s+(t.type==='income'?t.amount:-t.amount) : s, 0);
            const credit = app.cards.reduce((s, c) => s + c.used, 0);
            const assets = app.assets.reduce((s, a) => s + a.amount, 0);
            document.getElementById('totalNetWorth').innerText = (bank + assets - credit).toLocaleString();
            document.getElementById('statBank').innerText = bank.toLocaleString();
            document.getElementById('statCredit').innerText = credit.toLocaleString();
            document.getElementById('statAssets').innerText = assets.toLocaleString();
            
            const budgetDiv = document.getElementById('dashboardBudgets'); budgetDiv.innerHTML = '';
            const currentMonth = new Date().toISOString().slice(0, 7);
            const spending = {};
            app.txs.forEach(t => { if(t.type === 'expense' && t.date.startsWith(currentMonth)) spending[t.cat] = (spending[t.cat] || 0) + t.amount; });
            const activeBudgets = Object.keys(app.budgets);
            if(activeBudgets.length === 0) budgetDiv.innerHTML = `<button onclick="openDrillDown('budget')" class="text-xs text-blue-500 w-full text-center py-2 border border-dashed border-blue-200 rounded-xl">הגדר תקציב +</button>`;
            else activeBudgets.forEach(cat => { const limit = app.budgets[cat]; const used = spending[cat] || 0; const pct = Math.min(100, (used / limit) * 100); budgetDiv.innerHTML += `<div class="flex justify-between text-xs mb-1"><span class="font-bold">${cat}</span><span>${used.toLocaleString()} / ${limit.toLocaleString()}</span></div><div class="budget-track"><div class="budget-fill bg-blue-500" style="width: ${pct}%"></div></div>`; });

            const recentEl = document.getElementById('recentTxList'); recentEl.innerHTML = '';
            app.txs.sort((a,b) => b.timestamp - a.timestamp).slice(0, 5).forEach(tx => {
                const isInc = tx.type === 'income';
                recentEl.innerHTML += `<div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700 last:border-0"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${isInc ? 'bg-green-100 text-green-600' : 'bg-slate-100 text-slate-500'}"><i class="fa-solid ${isInc ? 'fa-arrow-down' : 'fa-bag-shopping'} text-sm"></i></div><div><div class="font-bold text-sm">${tx.desc}</div><div class="text-[10px] text-slate-400">${tx.date}</div></div></div><span class="font-bold text-sm ${isInc ? 'text-green-500' : ''}">${tx.amount.toLocaleString()}</span></div>`;
            });
        }

        // Transactions
        function setFormType(type) {
            formMode = type;
            const btnExp = document.getElementById('btn-exp'); const btnInc = document.getElementById('btn-inc'); const saveBtn = document.getElementById('saveBtn'); const methodLabel = document.getElementById('methodLabel');
            if (type === 'expense') { btnExp.className = 'flex-1 py-3 rounded-lg font-bold text-sm bg-white shadow text-red-500 transition'; btnInc.className = 'flex-1 py-3 rounded-lg font-bold text-sm text-slate-400 transition'; saveBtn.className = 'w-full bg-red-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-red-500/30 active:scale-95 transition mt-2'; saveBtn.innerText = 'רשום הוצאה'; methodLabel.innerText = 'מאיפה יורד הכסף?'; } 
            else { btnExp.className = 'flex-1 py-3 rounded-lg font-bold text-sm text-slate-400 transition'; btnInc.className = 'flex-1 py-3 rounded-lg font-bold text-sm bg-white shadow text-green-500 transition'; saveBtn.className = 'w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-green-500/30 active:scale-95 transition mt-2'; saveBtn.innerText = 'רשום הכנסה'; methodLabel.innerText = 'לאן הכסף נכנס?'; }
            renderFormOptions();
        }
        function renderFormOptions() {
            const list = document.getElementById('paymentMethodsList'); list.innerHTML = `<button onclick="selectMethod(this, 'bank')" class="flex-none px-4 py-2 rounded-xl text-xs bg-slate-800 text-white whitespace-nowrap ring-2 ring-slate-800 shadow-sm">עו"ש בנק</button>`;
            if (formMode === 'expense') app.cards.forEach(c => list.innerHTML += `<button onclick="selectMethod(this, '${c.id}')" class="flex-none px-4 py-2 rounded-xl text-xs bg-white border border-slate-200 text-slate-600 whitespace-nowrap shadow-sm">${c.name}</button>`);
            else app.assets.forEach(a => list.innerHTML += `<button onclick="selectMethod(this, 'asset_${a.id}')" class="flex-none px-4 py-2 rounded-xl text-xs bg-white border border-slate-200 text-slate-600 whitespace-nowrap shadow-sm">${a.name}</button>`);
            const catDiv = document.getElementById('categoryChips'); catDiv.innerHTML = '';
            (formMode === 'expense' ? app.catsExp : app.catsInc).forEach((cat, i) => { const cls = i === 0 ? 'bg-blue-100 text-blue-600 border-blue-200 shadow-sm' : 'bg-slate-50 text-slate-500 border-transparent'; catDiv.innerHTML += `<button onclick="selectCat(this, '${cat}')" class="cat-chip px-3 py-1.5 rounded-lg text-xs border ${cls}">${cat}</button>`; });
            document.getElementById('selectedCat').value = (formMode === 'expense' ? app.catsExp : app.catsInc)[0]; document.getElementById('selectedMethod').value = 'bank';
        }
        function selectMethod(btn, id) { document.querySelectorAll('#paymentMethodsList button').forEach(b => b.className = 'flex-none px-4 py-2 rounded-xl text-xs bg-white border border-slate-200 text-slate-600 whitespace-nowrap shadow-sm'); btn.className = 'flex-none px-4 py-2 rounded-xl text-xs bg-slate-800 text-white whitespace-nowrap shadow-md ring-2 ring-slate-800'; document.getElementById('selectedMethod').value = id; }
        function selectCat(btn, cat) { document.querySelectorAll('.cat-chip').forEach(b => b.className = 'cat-chip px-3 py-1.5 rounded-lg text-xs border bg-slate-50 text-slate-500 border-transparent'); btn.className = 'cat-chip px-3 py-1.5 rounded-lg text-xs border bg-blue-100 text-blue-600 border-blue-200 shadow-sm'; document.getElementById('selectedCat').value = cat; }
        
        function saveTransaction() {
            const amount = parseFloat(document.getElementById('inpAmount').value); const desc = document.getElementById('inpDesc').value; const cat = document.getElementById('selectedCat').value; const method = document.getElementById('selectedMethod').value;
            if(!amount || !desc) return alert('חסר מידע');
            if (formMode === 'expense' && !method.startsWith('bank')) { const card = app.cards.find(c => c.id === method); if (card) { if (card.used + amount > card.limit && !confirm('חריגה! להמשיך?')) return; card.used += amount; } }
            if (formMode === 'income' && method.startsWith('asset_')) { const asset = app.assets.find(a => a.id === method.replace('asset_', '')); if(asset) asset.amount += amount; }
            app.txs.push({ id: Date.now(), type: formMode, amount, desc, cat, date: new Date().toISOString().split('T')[0], method, timestamp: Date.now() });
            save(); document.getElementById('inpAmount').value = ''; document.getElementById('inpDesc').value = ''; nav('dashboard');
        }

        // Drill Down
        function openDrillDown(type) {
            const modal = document.getElementById('drillDownModal'); const content = document.getElementById('ddContent'); const title = document.getElementById('ddTitle'); modal.classList.remove('hidden'); content.innerHTML = '';
            if (type === 'budget') {
                title.innerText = 'תקציב'; content.innerHTML = `<p class="text-sm text-slate-500 mb-4">תקרה חודשית</p>`;
                app.catsExp.forEach(cat => { const currentLimit = app.budgets[cat] || 0; content.innerHTML += `<div class="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-xl mb-2 shadow-sm"><span class="font-bold text-sm">${cat}</span><input type="number" value="${currentLimit}" placeholder="0" class="w-24 text-center bg-slate-50 dark:bg-slate-900 rounded-lg p-2 text-sm" onchange="app.budgets['${cat}']=parseFloat(this.value);save();"></div>`; });
            } else if (type === 'credit') {
                title.innerText = 'כרטיסים'; content.innerHTML = `<button onclick="const n=prompt('שם');if(n){app.cards.push({id:'c'+Date.now(),name:n,limit:parseFloat(prompt('מסגרת')),used:0,day:10});save();openDrillDown('credit');}" class="w-full py-3 border border-dashed border-slate-300 text-slate-400 rounded-xl mb-4">+ הוסף</button>`;
                app.cards.forEach(c => { const pct = Math.min(100, (c.used/c.limit)*100); content.innerHTML += `<div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-3"><div class="flex justify-between mb-2"><span class="font-bold">${c.name}</span><span class="text-xs bg-slate-100 px-2 py-1 rounded">חיוב: ${c.day}</span></div><div class="flex justify-between text-xs mb-1 text-slate-500"><span>נוצל: ${c.used.toLocaleString()}</span><span>נותר: ${(c.limit-c.used).toLocaleString()}</span></div><div class="credit-bar-bg mb-3"><div class="credit-bar-fill bg-blue-500" style="width: ${pct}%"></div></div><div class="flex gap-2"><button onclick="updateCardBalance('${c.id}')" class="flex-1 text-xs bg-blue-50 text-blue-600 py-2 rounded font-bold">עדכון יתרה מהיר</button></div></div>`; });
            } else if (type === 'assets') {
                title.innerText = 'נכסים'; content.innerHTML = `<button onclick="addNewAsset()" class="w-full py-3 border border-dashed border-slate-300 text-slate-400 rounded-xl mb-4">+ הוסף</button>`;
                app.assets.forEach(a => { content.innerHTML += `<div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm flex justify-between items-center mb-2"><div><div class="font-bold">${a.name}</div><div class="text-xs text-slate-500">${a.type==='saving'?'חיסכון':'השקעה'}</div></div><div class="text-right"><div class="font-bold">${a.amount.toLocaleString()} ₪</div><button onclick="editAsset('${a.id}')" class="text-[10px] text-blue-500">עדכון שווי</button></div></div>`; });
            } else if (type === 'bank') { title.innerText = 'עו"ש בנק'; content.innerHTML = `<div class="p-4 text-center text-slate-500">לפירוט מלא עבור ליומן התנועות</div>`; }
        }

        function setBudget(cat, val) { app.budgets[cat] = parseFloat(val); save(); }
        function updateCardBalance(id) { const c = app.cards.find(x=>x.id===id); const val=parseFloat(prompt('כמה תפוס כרגע?', c.used)); if(!isNaN(val)) { c.used=val; save(); openDrillDown('credit'); } }
        function addNewCard() { const name=prompt('שם'); if(name) { app.cards.push({id:'c'+Date.now(), name, limit:parseFloat(prompt('מסגרת')), used:0, day:10}); save(); openDrillDown('credit'); } }
        function editAsset(id) { const a = app.assets.find(x=>x.id===id); const val=parseFloat(prompt('שווי עדכני', a.amount)); if(!isNaN(val)) { a.amount=val; save(); openDrillDown('assets'); } }
        function addNewAsset() { const name=prompt('שם'); if(name) { app.assets.push({id:'a'+Date.now(), name, amount:parseFloat(prompt('סכום')), type:'saving'}); save(); openDrillDown('assets'); } }
        function closeDrillDown() { document.getElementById('drillDownModal').classList.add('hidden'); renderDashboard(); }

        // General
        function updateDataList() { const list = document.getElementById('descOptions'); const u = [...new Set(app.txs.map(t => t.desc))]; list.innerHTML = u.map(d => `<option value="${d}">`).join(''); }
        function renderTransactions() { const list = document.getElementById('fullTxList'); list.innerHTML = ''; const txt = document.getElementById('searchDesc').value.toLowerCase(); app.txs.filter(t => t.desc.toLowerCase().includes(txt)).sort((a,b)=>b.timestamp-a.timestamp).forEach(tx => { const isInc = tx.type === 'income'; list.innerHTML += `<div class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm flex justify-between mb-2"><div class="flex gap-3"><div class="w-1 bg-${isInc?'green':'red'}-500 rounded-full"></div><div><div class="font-bold text-slate-700 dark:text-slate-200">${tx.desc}</div><div class="text-xs text-slate-400">${tx.date} • ${tx.cat}</div></div></div><div class="text-right"><div class="font-bold ${isInc?'text-green-500':'text-slate-800 dark:text-slate-200'}">${tx.amount.toLocaleString()}</div><button onclick="if(confirm('למחוק?')){app.txs=app.txs.filter(x=>x.id!==${tx.id});save();renderTransactions();}" class="text-[10px] text-red-300">מחק</button></div></div>`; }); }
        function loadProfile() { document.getElementById('set-name').value = app.profile.name; document.getElementById('set-account').value = app.profile.account; document.getElementById('set-branch').value = app.profile.branch; }
        function saveProfile() { app.profile.name = document.getElementById('set-name').value; app.profile.account = document.getElementById('set-account').value; app.profile.branch = document.getElementById('set-branch').value; save(); }
        function nav(view) { document.querySelectorAll('.view-section').forEach(el => { el.classList.add('hidden'); el.classList.remove('slide-up'); }); document.getElementById('view-'+view).classList.remove('hidden'); document.getElementById('view-'+view).classList.add('slide-up'); if(view==='add') setFormType('expense'); if(view==='transactions') renderTransactions(); }
        function updateClock() { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}); }
        function toggleTheme() { app.theme = app.theme==='dark'?'light':'dark'; document.documentElement.classList.toggle('dark'); save(); }
        function resetData() { if(confirm('פעולה זו תמחק את כל הנתונים לצמיתות! להמשיך?')) { localStorage.removeItem('moneyAppV9'); localStorage.removeItem('moneyAppV8'); location.reload(); } }
    </script>
</body>
</html>
