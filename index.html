<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MoneyStack Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #f3f4f6; touch-action: manipulation; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 12px; }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            // מצב הנתונים (נטען מהזיכרון של הטלפון)
            const [transactions, setTransactions] = useState(() => {
                const saved = localStorage.getItem('moneyStackData');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [view, setView] = useState('dashboard'); // dashboard, add, import
            const [newTx, setNewTx] = useState({ desc: '', amount: '', type: 'expense', category: 'כללי' });
            const [bankText, setBankText] = useState('');

            // שמירה אוטומטית בכל שינוי
            useEffect(() => {
                localStorage.setItem('moneyStackData', JSON.stringify(transactions));
            }, [transactions]);

            // חישובים ללוח הבקרה
            const totalIncome = transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const balance = totalIncome - totalExpense;

            // פונקציה להוספה ידנית
            const addTransaction = () => {
                if (!newTx.desc || !newTx.amount) return alert('נא למלא פרטים');
                const amount = parseFloat(newTx.amount) * (newTx.type === 'expense' ? -1 : 1);
                
                const tx = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('he-IL'),
                    desc: newTx.desc,
                    amount: amount,
                    category: newTx.category
                };

                setTransactions([tx, ...transactions]);
                setView('dashboard');
                setNewTx({ desc: '', amount: '', type: 'expense', category: 'כללי' });
            };

            // פונקציה למחיקת שורה
            const deleteTx = (id) => {
                if(confirm('למחוק את הפעולה?')) {
                    setTransactions(transactions.filter(t => t.id !== id));
                }
            };

            // פונקציה ליבוא מהבנק (הקוד הקודם שלנו משודרג)
            const processBankText = () => {
                const lines = bankText.split('\n');
                const newTxs = [];
                
                lines.forEach(line => {
                    if (line.includes('/') && (line.includes('|') || line.match(/\d/))) {
                        let parts = line.includes('|') ? line.split('|') : line.split(/\s\s+/);
                        parts = parts.map(p => p.trim());
                        
                        if (parts.length >= 3) {
                            let expense = parts[2] === '---' ? 0 : parseFloat(parts[2]?.replace(/,/g, ''));
                            let income = parts[3] === '---' ? 0 : parseFloat(parts[3]?.replace(/,/g, ''));
                            
                            // תיקון לוגיקה
                            if (!expense && !income) {
                                // נסיון הצלה אם הסדר שונה
                                expense = parseFloat(parts[2]) || 0;
                            }

                            const amount = income > 0 ? income : (expense * -1);
                            
                            if (amount !== 0 && !isNaN(amount)) {
                                newTxs.push({
                                    id: Math.random(), // זמני
                                    date: parts[0],
                                    desc: parts[1],
                                    amount: amount,
                                    category: 'בנק'
                                });
                            }
                        }
                    }
                });

                if (newTxs.length > 0) {
                    setTransactions([...newTxs, ...transactions]);
                    setView('dashboard');
                    setBankText('');
                    alert(`נוספו ${newTxs.length} תנועות בהצלחה!`);
                } else {
                    alert('לא זוהו תנועות. נסה להעתיק שוב.');
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-20">
                    
                    {/* כותרת עליונה */}
                    <div className="bg-blue-900 text-white p-6 rounded-b-3xl shadow-lg mb-6">
                        <h1 className="text-xl font-bold opacity-80 mb-2">היתרה שלך</h1>
                        <div className="text-4xl font-bold flex items-baseline gap-2" dir="ltr">
                            <span>₪</span>
                            <span>{balance.toLocaleString()}</span>
                        </div>
                        
                        <div className="flex gap-4 mt-6">
                            <div className="bg-white/10 p-3 rounded-xl flex-1 backdrop-blur-sm">
                                <div className="text-xs opacity-70 mb-1">הכנסות</div>
                                <div className="text-lg font-bold text-green-300">+{totalIncome.toLocaleString()}</div>
                            </div>
                            <div className="bg-white/10 p-3 rounded-xl flex-1 backdrop-blur-sm">
                                <div className="text-xs opacity-70 mb-1">הוצאות</div>
                                <div className="text-lg font-bold text-red-300">-{totalExpense.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    {/* מסך ראשי - רשימת תנועות */}
                    {view === 'dashboard' && (
                        <div className="px-4">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="font-bold text-gray-700 text-lg">פעולות אחרונות</h2>
                                <button onClick={() => {
                                    if(confirm('למחוק את כל הנתונים?')) setTransactions([]);
                                }} className="text-xs text-red-500">איפוס נתונים</button>
                            </div>
                            
                            <div className="space-y-3">
                                {transactions.length === 0 ? (
                                    <div className="text-center py-10 text-gray-400">
                                        <i className="fa-solid fa-wallet text-4xl mb-3"></i>
                                        <p>אין נתונים עדיין</p>
                                    </div>
                                ) : (
                                    transactions.map(tx => (
                                        <div key={tx.id} className="card p-4 flex justify-between items-center animate-fade-in relative group">
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${tx.amount > 0 ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                                    <i className={`fa-solid ${tx.amount > 0 ? 'fa-arrow-down' : 'fa-arrow-up'}`}></i>
                                                </div>
                                                <div>
                                                    <div className="font-bold text-gray-800">{tx.desc}</div>
                                                    <div className="text-xs text-gray-500">{tx.date} • {tx.category}</div>
                                                </div>
                                            </div>
                                            <div className="flex flex-col items-end">
                                                <span className={`font-bold ${tx.amount > 0 ? 'text-green-600' : 'text-gray-900'}`} dir="ltr">
                                                    {tx.amount.toLocaleString()} ₪
                                                </span>
                                                <button onClick={() => deleteTx(tx.id)} className="text-xs text-red-400 mt-1">מחק</button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}

                    {/* מסך הוספה ידנית */}
                    {view === 'add' && (
                        <div className="px-4 animate-slide-up">
                            <h2 className="font-bold text-xl mb-4 text-gray-800">הוספת תנועה חדשה</h2>
                            
                            <div className="card p-6">
                                <label className="block text-sm font-bold text-gray-700 mb-2">סוג פעולה</label>
                                <div className="flex gap-2 mb-4">
                                    <button 
                                        onClick={() => setNewTx({...newTx, type: 'expense'})}
                                        className={`flex-1 py-3 rounded-xl font-bold transition ${newTx.type === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-500'}`}
                                    >הוצאה</button>
                                    <button 
                                        onClick={() => setNewTx({...newTx, type: 'income'})}
                                        className={`flex-1 py-3 rounded-xl font-bold transition ${newTx.type === 'income' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-500'}`}
                                    >הכנסה</button>
                                </div>

                                <input type="text" placeholder="תיאור (למשל: שווארמה)" className="input-field" 
                                    value={newTx.desc} onChange={e => setNewTx({...newTx, desc: e.target.value})} />
                                
                                <input type="number" placeholder="סכום" className="input-field"
                                    value={newTx.amount} onChange={e => setNewTx({...newTx, amount: e.target.value})} />

                                <select className="input-field bg-white" 
                                    value={newTx.category} onChange={e => setNewTx({...newTx, category: e.target.value})}>
                                    <option>כללי</option>
                                    <option>מזון</option>
                                    <option>רכב</option>
                                    <option>בית</option>
                                    <option>משכורת</option>
                                    <option>בילויים</option>
                                </select>

                                <button onClick={addTransaction} className="w-full btn-primary py-4 rounded-xl font-bold text-lg shadow-lg mt-2">
                                    שמור פעולה
                                </button>
                                <button onClick={() => setView('dashboard')} className="w-full text-gray-500 py-3 mt-2">ביטול</button>
                            </div>
                        </div>
                    )}

                    {/* מסך יבוא מהבנק */}
                    {view === 'import' && (
                        <div className="px-4">
                            <h2 className="font-bold text-xl mb-4 text-gray-800">ייבוא מהבנק</h2>
                            <div className="card p-4">
                                <textarea 
                                    className="w-full h-40 p-3 border rounded-xl mb-4 bg-gray-50" 
                                    placeholder="הדבק כאן את הטקסט מה-Note..."
                                    value={bankText}
                                    onChange={e => setBankText(e.target.value)}
                                ></textarea>
                                <button onClick={processBankText} className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold">
                                    נתח והוסף
                                </button>
                                <button onClick={() => setView('dashboard')} className="w-full text-gray-500 py-3 mt-2">ביטול</button>
                            </div>
                        </div>
                    )}

                    {/* סרגל ניווט תחתון */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 px-6 flex justify-between items-center pb-6">
                        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center ${view === 'dashboard' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <i className="fa-solid fa-house text-xl mb-1"></i>
                            <span className="text-xs">ראשי</span>
                        </button>
                        
                        <button onClick={() => setView('add')} className="bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center -mt-8 shadow-lg shadow-blue-300">
                            <i className="fa-solid fa-plus text-2xl"></i>
                        </button>
                        
                        <button onClick={() => setView('import')} className={`flex flex-col items-center ${view === 'import' ? 'text-blue-600' : 'text-gray-400'}`}>
                            <i className="fa-solid fa-file-import text-xl mb-1"></i>
                            <span className="text-xs">ייבוא</span>
                        </button>
                    </div>

                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
