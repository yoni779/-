<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <title>YoniOS Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js"></script>

    <style>
        body { 
            font-family: 'Rubik', sans-serif; 
            background-color: #F3F4F6; 
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,0.05) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,0.05) 0, transparent 50%);
            padding-bottom: env(safe-area-inset-bottom);
        }
        [x-cloak] { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255,255,255,0.6); }
        .glass-card { background: white; box-shadow: 0 8px 30px rgba(0,0,0,0.06); border-radius: 24px; border: 1px solid #fff; }
        .input-premium { background: #F3F4F6; border: 1px solid #E5E7EB; border-radius: 16px; padding: 16px; width: 100%; outline: none; transition: 0.3s; font-size: 16px; }
        .input-premium:focus { background: white; border-color: #4F46E5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        
        /* ×× ×™××¦×™×•×ª */
        .modal-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden" x-data="app()">

    <audio id="sound-success" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sound-buy" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>
    <audio id="sound-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>

    <div x-show="!user.isLoggedIn" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center p-8 fade-in">
        <div class="w-24 h-24 bg-blue-600 rounded-[2rem] flex items-center justify-center text-white text-5xl shadow-2xl shadow-blue-200 mb-8 rotate-12">
            <i class="fa-solid fa-rocket"></i>
        </div>
        <h1 class="text-4xl font-black text-gray-900 mb-2">YoniOS Ultimate</h1>
        <p class="text-gray-400 mb-10 text-center">×”×—×™×™× ×©×œ×š, ××©×•×“×¨×’×™×.</p>
        <div class="w-full max-w-xs space-y-4">
            <input type="text" x-model="loginForm.name" class="input-premium" placeholder="×©× ×¤×¨×˜×™">
            <input type="email" x-model="loginForm.email" class="input-premium" placeholder="××™××™×™×œ (×œ×©××™×¨×” ×‘×¢× ×Ÿ)">
            <button @click="login()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold mt-4 shadow-lg active:scale-95 transition-transform">
                <span x-show="!isLoading">×›× ×™×¡×” ×œ××¢×¨×›×ª</span>
                <span x-show="isLoading"><i class="fa-solid fa-circle-notch fa-spin"></i> ×˜×•×¢×Ÿ ×¤×¨×•×¤×™×œ...</span>
            </button>
        </div>
    </div>

    <div x-show="user.isLoggedIn" class="flex-1 flex flex-col h-full relative" x-cloak>
        
        <header class="px-6 pt-12 pb-4 flex justify-between items-center glass sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-800 to-slate-900 text-white flex items-center justify-center font-bold text-lg shadow-md">
                    <span x-text="user.name.charAt(0)"></span>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-none" x-text="user.name"></h1>
                    <p class="text-[10px] font-bold mt-1 px-2 py-0.5 bg-green-100 text-green-700 rounded-full inline-block" x-text="syncStatus"></p>
                </div>
            </div>
            <div class="bg-white px-4 py-2 rounded-full font-black text-blue-600 shadow-sm border flex items-center gap-2">
                <span x-text="coins"></span> ğŸ’
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-5 pb-36 fade-in">
            
            <div x-show="tab !== 'profile'" class="w-full bg-slate-900 text-white p-6 rounded-[2rem] mb-8 relative overflow-hidden shadow-2xl shadow-slate-200">
                <div class="relative z-10 flex justify-between items-end">
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase mb-1 tracking-widest">LEVEL</p>
                        <h2 class="text-5xl font-black" x-text="Math.floor(coins/100) + 1"></h2>
                    </div>
                    <div class="text-right w-1/2">
                        <p class="text-xs text-gray-400 mb-2">×”×ª×§×“××•×ª ×œ×“×¨×’×” ×”×‘××”</p>
                        <div class="w-full h-3 bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-700" :style="`width: ${coins % 100}%`"></div></div>
                    </div>
                </div>
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-blue-600 rounded-full blur-3xl opacity-20"></div>
            </div>

            <div x-show="tab === 'tasks'">
                
                <div class="mb-8">
                    <h2 class="font-bold text-lg text-gray-400 mb-3 px-2 uppercase tracking-wider text-xs">×”×¨×’×œ×™× ×™×•××™×™× â˜€ï¸</h2>
                    <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                        <template x-for="(habit, i) in habits" :key="i">
                            <div @click="toggleHabit(i)" class="flex-shrink-0 w-24 h-32 glass-card flex flex-col items-center justify-center p-2 transition-all active:scale-95 border-2"
                                 :class="habit.lastDone === todayStr ? 'border-green-400 bg-green-50' : 'border-transparent'">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl mb-2 transition-colors"
                                     :class="habit.lastDone === todayStr ? 'bg-green-500 text-white shadow-lg shadow-green-200' : 'bg-gray-100 text-gray-400'">
                                    <i class="fa-solid" :class="habit.icon || 'fa-check'"></i>
                                </div>
                                <p class="text-xs font-bold text-center leading-tight" x-text="habit.name"></p>
                            </div>
                        </template>
                        <div @click="openModal('habit')" class="flex-shrink-0 w-24 h-32 glass-card flex flex-col items-center justify-center p-2 border-2 border-dashed border-gray-200 text-gray-400">
                            <i class="fa-solid fa-plus text-xl"></i>
                            <span class="text-[10px] mt-2 font-bold">×”×•×¡×£</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="font-bold text-lg text-gray-400 mb-3 px-2 uppercase tracking-wider text-xs">××©×™××•×ª ×©×•×˜×¤×•×ª</h2>
                    <div class="space-y-3">
                        <template x-for="(task, i) in tasks" :key="i">
                            <div class="glass-card p-4 flex items-center gap-4 relative overflow-hidden transition-all active:scale-[0.99]">
                                <div class="absolute right-0 top-0 bottom-0 w-1.5" :class="task.color || 'bg-gray-300'"></div>
                                
                                <button @click="toggleTask(i)" class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors mr-2" 
                                    :class="task.completed ? 'bg-green-500 border-green-500' : 'border-gray-300'">
                                    <i x-show="task.completed" class="fa-solid fa-check text-white text-[10px]"></i>
                                </button>
                                
                                <div class="flex-1">
                                    <p class="font-bold text-base" :class="task.completed ? 'line-through text-gray-400' : ''" x-text="task.title"></p>
                                    <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded mt-1 inline-block" x-text="'+' + task.reward + ' XP'"></span>
                                </div>
                                
                                <button @click="deleteItem('tasks', i)" class="w-8 h-8 rounded-full bg-red-50 text-red-400 flex items-center justify-center opacity-60 hover:opacity-100">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        </template>
                        
                        <div x-show="tasks.length === 0" class="text-center py-10 text-gray-400">
                            <i class="fa-solid fa-mug-hot text-4xl mb-2 opacity-30"></i>
                            <p>×”×›×œ × ×§×™! ×–××Ÿ ×œ× ×•×—.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="tab === 'shop'">
                <h2 class="font-bold text-xl text-gray-800 mb-4 px-1">××¨×§×˜×¤×œ×™×™×¡</h2>
                <div class="grid grid-cols-2 gap-4">
                    <template x-for="(item, i) in shopItems" :key="i">
                        <div class="glass-card p-5 text-center relative border border-transparent active:border-blue-200">
                            <button @click="deleteItem('shopItems', i)" class="absolute top-2 left-2 text-gray-300"><i class="fa-solid fa-times"></i></button>
                            <div class="text-3xl mb-3">ğŸ</div>
                            <h3 class="font-bold text-gray-800 leading-tight mb-1" x-text="item.name"></h3>
                            <p class="text-xs text-blue-600 font-bold mb-4"><span x-text="item.cost"></span> ×™×”×œ×•××™×</p>
                            <button @click="buy(item)" class="w-full py-2.5 rounded-xl text-xs font-bold transition-colors" :class="coins >= item.cost ? 'bg-gray-900 text-white shadow-lg' : 'bg-gray-100 text-gray-400'">×¨×›×•×©</button>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="tab === 'profile'" class="px-2">
                <div class="glass-card p-8 text-center mt-2">
                    <div class="w-24 h-24 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl">ğŸ‘¤</div>
                    <h2 class="text-2xl font-black" x-text="user.name"></h2>
                    <p class="text-gray-500 mb-8" x-text="user.email"></p>
                    
                    <div class="bg-gray-50 p-4 rounded-2xl mb-6 text-right">
                        <p class="text-xs font-bold text-gray-400 uppercase mb-4">×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª (× ×§×•×“×•×ª)</p>
                        <div class="flex justify-between items-end h-24 gap-2">
                            <template x-for="(val, day) in history" :key="day">
                                <div class="w-full bg-blue-200 rounded-t-lg relative group" :style="`height: ${Math.min(val, 100)}%`">
                                    <div class="absolute bottom-0 w-full text-center text-[10px] text-gray-500 -mb-5" x-text="day"></div>
                                </div>
                            </template>
                        </div>
                        <div class="h-5"></div>
                    </div>

                    <button @click="logout()" class="w-full bg-red-50 text-red-500 py-4 rounded-xl font-bold">×”×ª× ×ª×§ ××”×—×©×‘×•×Ÿ</button>
                </div>
            </div>
        </main>

        <button x-show="tab === 'tasks' || tab === 'shop'" 
            @click="openModal(tab === 'tasks' ? 'task' : 'shop')" 
            class="fixed bottom-24 left-6 w-16 h-16 bg-blue-600 text-white rounded-[1.2rem] shadow-xl shadow-blue-300 flex items-center justify-center text-2xl z-40 transition-transform hover:scale-105 active:scale-95">
            <i class="fa-solid fa-plus"></i>
        </button>

        <div class="fixed bottom-6 left-4 right-4 z-40">
            <nav class="glass px-2 py-2 rounded-[1.5rem] flex justify-around items-center shadow-2xl shadow-gray-300/50">
                <button @click="switchTab('tasks')" class="p-4 rounded-xl transition-all duration-300" :class="tab === 'tasks' ? 'bg-slate-900 text-white shadow-lg scale-105' : 'text-gray-400'"><i class="fa-solid fa-list-check text-xl"></i></button>
                <button @click="switchTab('shop')" class="p-4 rounded-xl transition-all duration-300" :class="tab === 'shop' ? 'bg-slate-900 text-white shadow-lg scale-105' : 'text-gray-400'"><i class="fa-solid fa-store text-xl"></i></button>
                <button @click="switchTab('profile')" class="p-4 rounded-xl transition-all duration-300" :class="tab === 'profile' ? 'bg-slate-900 text-white shadow-lg scale-105' : 'text-gray-400'"><i class="fa-solid fa-chart-simple text-xl"></i></button>
            </nav>
        </div>

        <div x-show="modal.isOpen" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm" x-cloak>
            <div @click.away="modal.isOpen = false" class="bg-white w-full max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 modal-enter shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" x-text="modal.title"></h3>
                    <button @click="modal.isOpen = false" class="bg-gray-100 w-8 h-8 rounded-full text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 mr-1">×›×•×ª×¨×ª</label>
                        <input x-model="modal.data.name" type="text" class="input-premium" placeholder="××” ×œ×”×•×¡×™×£?">
                    </div>
                    
                    <div x-show="modal.type === 'task'">
                        <label class="text-xs font-bold text-gray-400 mr-1">×§×˜×’×•×¨×™×”</label>
                        <div class="flex gap-2 mt-1">
                            <button @click="modal.data.color = 'bg-red-500'" class="h-10 flex-1 rounded-xl border-2" :class="modal.data.color === 'bg-red-500' ? 'border-red-500 bg-red-50' : 'border-transparent bg-gray-100'"><div class="w-3 h-3 rounded-full bg-red-500 mx-auto mt-3"></div></button>
                            <button @click="modal.data.color = 'bg-blue-500'" class="h-10 flex-1 rounded-xl border-2" :class="modal.data.color === 'bg-blue-500' ? 'border-blue-500 bg-blue-50' : 'border-transparent bg-gray-100'"><div class="w-3 h-3 rounded-full bg-blue-500 mx-auto mt-3"></div></button>
                            <button @click="modal.data.color = 'bg-green-500'" class="h-10 flex-1 rounded-xl border-2" :class="modal.data.color === 'bg-green-500' ? 'border-green-500 bg-green-50' : 'border-transparent bg-gray-100'"><div class="w-3 h-3 rounded-full bg-green-500 mx-auto mt-3"></div></button>
                            <button @click="modal.data.color = 'bg-yellow-500'" class="h-10 flex-1 rounded-xl border-2" :class="modal.data.color === 'bg-yellow-500' ? 'border-yellow-500 bg-yellow-50' : 'border-transparent bg-gray-100'"><div class="w-3 h-3 rounded-full bg-yellow-500 mx-auto mt-3"></div></button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-400 mr-1" x-text="modal.type === 'shop' ? '××—×™×¨' : '× ×™×§×•×“ (XP)'"></label>
                        <input x-model="modal.data.value" type="number" class="input-premium" placeholder="0">
                    </div>
                    
                    <button @click="saveModal()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold mt-2 shadow-lg">×©××•×¨</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMBx4Udu3w9iR6GpEcl561TNWGRc1UVQ0",
            authDomain: "yoni-os.firebaseapp.com",
            databaseURL: "https://yoni-os-default-rtdb.firebaseio.com",
            projectId: "yoni-os",
            storageBucket: "yoni-os.firebasestorage.app",
            messagingSenderId: "238428366388",
            appId: "1:238428366388:web:70e54810382d3d88134c61"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.database();

        function app() {
            return {
                tab: 'tasks',
                isLoading: false,
                syncStatus: '×˜×•×¢×Ÿ...',
                dataLoaded: false,
                coins: 0,
                user: { isLoggedIn: false, name: '', email: '' },
                loginForm: { name: '', email: '' },
                tasks: [],
                habits: [],
                shopItems: [],
                history: {'×':0,'×‘':0,'×’':0,'×“':0,'×”':0,'×•':0,'×©':0},
                todayStr: new Date().toLocaleDateString('he-IL'),
                
                // Modal State
                modal: { isOpen: false, type: '', title: '', data: { name: '', value: '', color: 'bg-blue-500' } },
                dbRef: null,

                init() {
                    const saved = localStorage.getItem('yoni_ultimate_auth');
                    if(saved) {
                        this.loginForm = JSON.parse(saved);
                        this.login();
                    }
                },

                login() {
                    if(!this.loginForm.email) return;
                    this.isLoading = true;
                    const safeEmail = this.loginForm.email.toLowerCase().replace(/\./g, '_').replace(/@/g, '_at_');
                    this.dbRef = db.ref('users/' + safeEmail);
                    
                    this.dbRef.on('value', (snap) => {
                        this.isLoading = false;
                        const val = snap.val();
                        this.user.isLoggedIn = true;
                        this.user.name = this.loginForm.name;
                        this.user.email = this.loginForm.email.toLowerCase();
                        localStorage.setItem('yoni_ultimate_auth', JSON.stringify(this.user));

                        if(val) {
                            this.coins = val.coins || 0;
                            this.tasks = val.tasks || [];
                            this.shopItems = val.shopItems || [];
                            this.habits = val.habits || [];
                            this.history = val.history || this.history;
                            
                            // ××™×¤×•×¡ ×”×¨×’×œ×™× ×™×•××™
                            this.checkHabitsReset();
                        }
                        
                        this.dataLoade
