<script>
    // --- ××¡×“ × ×ª×•× ×™×: ×©×™×¢×•×¨×™× ××•×‘× ×™× ---
    const DATABASE = {
        finance: [
            { t: "×ª×–×¨×™× ××–×•×× ×™×", c: "×”×”×‘×“×œ ×‘×™×Ÿ ×¨×•×•×— ×œ×›×¡×£ ×‘×‘× ×§ ×”×•× ×§×¨×™×˜×™. ×¨×•×•×— ×”×•× ×ª×™××•×¨×˜×™ (×—×©×‘×•× ×™×ª ×©×™×¦××”), ×ª×–×¨×™× ×”×•× ×”×›×¡×£ ×©× ×›× ×¡ ×‘×¤×•×¢×œ. ×× ×™×© ×œ×š ×”×•×¦××•×ª ×”×™×•× ××‘×œ ×”×›×¡×£ × ×›× ×¡ ×¢×•×“ 60 ×™×•×, ××ª×” ×‘×‘×¢×™×”.", q: "××” ×”×¤×ª×¨×•×Ÿ ×œ×‘×¢×™×™×ª ×ª×–×¨×™×?", o: ["×œ×§×—×ª ×”×œ×•×•××•×ª ×œ×œ× ×›×™×¡×•×™", "×œ×‘×§×© ××§×“××•×ª ××œ×§×•×—×•×ª ×•×“×—×™×™×ª ×ª×©×œ×•× ×œ×¡×¤×§×™×", "×œ×”×ª×¢×œ×"], a: 1 },
            { t: "×“×•×— ×¨×•×•×— ×•×”×¤×¡×“ (P&L)", c: "×× ×›\"×œ ×—×™×™×‘ ×œ×“×¢×ª ×œ×§×¨×•× ×“×•×— ×¨×•×•×— ×•×”×¤×¡×“. ×”×”×›× ×¡×•×ª ×œ××¢×œ×”, ×”×”×•×¦××•×ª ×‘×××¦×¢, ×”×¨×•×•×— ×œ××˜×”. ×©×™× ×œ×‘ ×œ×”×•×¦××•×ª ×§×‘×•×¢×•×ª (×©×›×™×¨×•×ª) ××•×œ ××©×ª× ×•×ª (×—×•××¨ ×’×œ×).", q: "××”×™ ×”×•×¦××” ×§×‘×•×¢×”?", o: ["×§× ×™×™×ª ×¡×—×•×¨×”", "×©×›×¨ ×“×™×¨×” ×•××¨× ×•× ×”", "×‘×•× ×•×¡ ×œ×¢×•×‘×“ ××¦×˜×™×™×Ÿ"], a: 1 },
            { t: "ROI (×”×—×–×¨ ×”×©×§×¢×”)", c: "×œ×¤× ×™ ×›×œ ×”×•×¦××” ×ª×©××œ: ××” ×”-ROI? ×× ×”×©×§×¢×ª 100 ×©×§×œ ×‘×¤×¨×¡×•× ×•×”×›× ×¡×ª 150, ×”-ROI ×”×•× ×—×™×•×‘×™. ×× ×”×©×§×¢×ª ×‘××›×•× ×” ×—×“×©×” ×•×”×™× ×—×•×¡×›×ª ×œ×š ×–××Ÿ ×¢×‘×•×“×”, ×–×” ×’× ROI.", q: "××ª×™ ×›×“××™ ×œ×”×©×§×™×¢?", o: ["×›×©×”×”×—×–×¨ ×”×¦×¤×•×™ ×’×‘×•×” ××”×¢×œ×•×ª", "×›×©×‘× ×œ×™ ×œ×”×ª×—×“×©", "×›×©×›×•×œ× ××©×§×™×¢×™×"], a: 0 }
        ],
        marketing: [
            { t: "××™ ×§×”×œ ×”×™×¢×“?", c: "××œ ×ª××›×•×¨ ×œ×›×•×œ×. ×ª××›×•×¨ ×œ××™ ×©×¦×¨×™×š ××•×ª×š. ×ª×’×“×™×¨: ×’×™×œ, ××™×§×•×, ×ª×—×•××™ ×¢× ×™×™×Ÿ. ×›×›×œ ×©×ª×”×™×” ×××•×§×“ ×™×•×ª×¨, ×”×©×™×•×•×§ ×™×¢×œ×” ×¤×—×•×ª ×•×™×›× ×™×¡ ×™×•×ª×¨.", q: "×œ××” ×œ×¤×œ×— ×©×•×§?", o: ["×›×“×™ ×œ×”×’×™×¢ ×œ×× ×©×™× ×”×¨×œ×•×•× ×˜×™×™× ×‘×™×•×ª×¨", "×›×“×™ ×œ×”×¤×¡×™×“ ×œ×§×•×—×•×ª", "×–×” ×œ× ×—×©×•×‘"], a: 0 },
            { t: "LTV (×¢×¨×š ×—×™×™ ×œ×§×•×—)", c: "×œ×§×•×— ×”×•× ×œ× ×¢×¡×§×” ×—×“ ×¤×¢××™×ª. ×”××˜×¨×” ×”×™× ×©×”×•× ×™×—×–×•×¨ ×©×•×‘ ×•×©×•×‘. ×œ×§×•×— ×©×§× ×” ×‘-50 ×©×§×œ ××‘×œ ×—×•×–×¨ ×›×œ ×—×•×“×© ×‘××©×š ×©× ×”, ×©×•×•×” ×œ×š 600 ×©×§×œ.", q: "××™×š ××’×“×™×œ×™× LTV?", o: ["××¢×œ×™× ××—×™×¨ ×‘×œ×™ ×œ×”×•×“×™×¢", "×©×•××¨×™× ×¢×œ ×§×©×¨ ×•×©×™×¨×•×ª ××¢×•×œ×” ×œ××•×¨×š ×–××Ÿ", "××ª×¢×œ××™× ××× ×• ××—×¨×™ ×”×§× ×™×™×”"], a: 1 }
        ],
        ops: [
            { t: "× ×™×”×•×œ ××œ××™", c: "××œ××™ ×–×” ×›×¡×£ ×©×™×•×©×‘ ×¢×œ ×”××“×£. ×™×•×ª×¨ ××“×™ ××œ××™? ×”×›×¡×£ ×ª×§×•×¢. ×¤×—×•×ª ××“×™? ××ª×” ××¤×¡×¤×¡ ××›×™×¨×•×ª. ×”×—×•×›××” ×”×™× ×œ××¦×•× ××ª ×”××™×–×•×Ÿ (Just in Time).", q: "××” ×”×¡×›× ×” ×‘××œ××™ ×¢×•×“×£?", o: ["×©×”××“×¤×™× ×™×¨××• ××œ××™×", "×‘×œ××™, ×’× ×™×‘×•×ª ×•×›×¡×£ ×ª×§×•×¢", "××™×Ÿ ×¡×›× ×”"], a: 1 },
            { t: "××—×–×§×” ××•× ×¢×ª", c: "××œ ×ª×—×›×” ×©×”××–×’×Ÿ ×™×ª×¤×•×¦×¥ ×‘×™×•× ×”×›×™ ×—×. ××—×–×§×” ××•× ×¢×ª ×¢×•×œ×” ×›×¡×£ ×¢×›×©×™×•, ××‘×œ ×—×•×¡×›×ª ×”×•×Ÿ ××—×¨ ×›×š ×¢×œ ×”×©×‘×ª×ª ×”×¢×¡×§ ×•×ª×™×§×•× ×™ ×—×™×¨×•×.", q: "××”×™ ×’×™×©×ª ××—×–×§×” ××•× ×¢×ª?", o: ["×œ×ª×§×Ÿ ×¨×§ ×›×©× ×©×‘×¨", "×œ×‘×¦×¢ ×‘×“×™×§×•×ª ×ª×§×•×¤×ª×™×•×ª ×›×“×™ ×œ×× ×•×¢ ×ª×§×œ×•×ª", "×œ×§× ×•×ª ×ª××™×“ ×—×“×©"], a: 1 }
        ],
        hr: [
            { t: "×’×™×•×¡ ×¢×•×‘×“×™×", c: "××œ ×ª×’×™×™×¡ ××ª ××™ ×©×”×›×™ ×–×•×œ, ×ª×’×™×™×¡ ××ª ××™ ×©×”×›×™ ××ª××™×. ×¢×•×‘×“ ×’×¨×•×¢ ×¢×•×œ×” ×œ×š ×‘× ×–×§×™×, ×–××Ÿ × ×™×”×•×œ ×•×¢×•×’××ª × ×¤×© ×™×•×ª×¨ ××”××©×›×•×¨×ª ×©×œ×•.", q: "××” ×—×©×•×‘ ×‘×¨××™×•×Ÿ?", o: ["×¨×§ ×”×©×›×¨ ×©×”×•× ××‘×§×©", "×”×™×›×•×œ×ª, ×”××•×¤×™ ×•×”×”×ª×××” ×œ×¦×•×•×ª", "××™×¤×” ×”×•× ×’×¨"], a: 1 },
            { t: "×”××¦×œ×ª ×¡××›×•×™×•×ª", c: "××ª×” ×œ× ×™×›×•×œ ×œ×¢×©×•×ª ×”×›×œ. ×× ××ª×” ×¢×•×©×” ×¢×‘×•×“×” ×©×œ ×¢×•×‘×“ ×–×•×˜×¨, ××ª×” ××¤×¡×™×“ ×›×¡×£ ×›×× ×›\"×œ. ×ª×œ××“ ×œ×¡××•×š, ×œ×ª×ª ××©×™××•×ª ×•×œ×‘×“×•×§ ×‘×™×¦×•×¢×™×.", q: "×œ××” ×× ×”×œ×™× ×—×•×©×©×™× ×œ×”××¦×™×œ?", o: ["×¤×—×“ ×©×”×¢×•×‘×“ ×™×¢×©×” ×˜×¢×•×ª", "×›×™ ××™×Ÿ ×œ×”× ×¢×‘×•×“×”", "×›×™ ×”× ×¢×¦×œ× ×™×"], a: 0 }
        ]
    };

    // --- ××—×•×œ×œ ×”××™×¨×•×¢×™× ×”××™× ×¡×•×¤×™ ---
    const EVENTS_TEMPLATES = [
        { text: "×¦×™× ×•×¨ ××™× ×”×ª×¤×•×¦×¥ ×‘×—× ×•×ª ×‘×××¦×¢ ×”×™×•×!", opts: ["×¡×’×•×¨ ××ª ×”×—× ×•×ª ×•×ª×§×Ÿ ×œ×‘×“ (×”×¤×¡×“ ×”×›× ×¡×”)", "×”×–××Ÿ ××™× ×¡×˜×œ×˜×•×¨ ×—×™×¨×•× ($500)", "×©×™× ×“×œ×™ ×•×ª××©×™×š ×›×¨×’×™×œ"], outcomes: [-1000, -500, -2000] },
        { text: "×œ×§×•×— ×›×•×¢×¡ ×××™×™× ×‘×ª×‘×™×¢×” ×‘×’×œ×œ ××•×¦×¨ ×¤×’×•×.", opts: ["×”×¦×¢ ×œ×• ×¤×™×¦×•×™ ××œ× ×•××ª× ×” ($100)", "×”×ª×¢×œ× ××× ×•", "×ª××©×™× ××ª ×—×‘×¨×ª ×”××©×œ×•×—×™×"], outcomes: [-100, -1000, -500] },
        { text: "×”××ª×—×¨×” ×”×•×¨×™×“ ××—×™×¨×™× ×‘-20%. ××” ×ª×¢×©×”?", opts: ["×”×•×¨×“ ××—×™×¨×™× ×’× ××ª×” (×¤×’×™×¢×” ×‘×¨×•×•×—)", "×¦× ×‘×§××¤×™×™×Ÿ ×¢×œ ××™×›×•×ª ×”××•×¦×¨ ($300)", "××œ ×ª×¢×©×” ×›×œ×•×"], outcomes: [-500, -300, -100] },
        { text: "×¢×•×‘×“ ××¨×›×–×™ ××‘×§×© ×”×¢×œ××” ××• ×©×”×•× ×¢×•×–×‘.", opts: ["×ª×Ÿ ×œ×• ×”×¢×œ××” ($200 ×‘×—×•×“×©)", "×ª×Ÿ ×œ×• ×œ×œ×›×ª ×•×ª×’×™×™×¡ ×—×“×©", "×”×¦×¢ ×‘×•× ×•×¡ ×—×“ ×¤×¢××™ ($500)"], outcomes: [-200, -1000, -500] },
        { text: "×™×© ×œ×š ×¢×•×“×£ ××–×•×× ×™× ×©×œ $5,000. ××” ×ª×¢×©×”?", opts: ["×”×©××¨ ×‘×‘× ×§ ×œ×™×•× ×©×—×•×¨", "×”×©×§×¢ ×‘×©×™×¤×•×¥ ×”×¢×¡×§", "×—×œ×§ ×“×™×‘×™×“× ×“ (×§×— ×œ×›×™×¡)"], outcomes: [0, 1000, 5000] }
    ];

    // --- ××©×ª× ×™ ××¢×¨×›×ª ---
    let player = {
        money: 10000,
        rank: "×× ×›\"×œ ××ª×—×™×œ",
        progress: { finance: 0, marketing: 0, ops: 0, hr: 0 }
    };

    // ×œ××¢×‘×¨ ××•×˜×•××˜×™
    let autoNextTimeout = null;

    // ×˜×¢×™× ×” ××©××™×¨×”
    if (localStorage.getItem('ceoSimSave')) {
        player = JSON.parse(localStorage.getItem('ceoSimSave'));
    }
    updateUI();

    function updateUI() {
        document.getElementById('moneyDisplay').innerText = "$" + player.money.toLocaleString();
        document.getElementById('rankDisplay').innerText = getRankName();

        document.getElementById('prog-finance').innerText = "×©×™×¢×•×¨ " + (player.progress.finance + 1);
        document.getElementById('prog-marketing').innerText = "×©×™×¢×•×¨ " + (player.progress.marketing + 1);
        document.getElementById('prog-ops').innerText = "×©×™×¢×•×¨ " + (player.progress.ops + 1);
        document.getElementById('prog-hr').innerText = "×©×™×¢×•×¨ " + (player.progress.hr + 1);
    }

    function getRankName() {
        let total = player.progress.finance + player.progress.marketing + player.progress.ops + player.progress.hr;
        // ×§×•×“× ×”×’×‘×•×”, ××—"×› ×”× ××•×š
        if (total > 20) return "×× ×›\"×œ ××™××¤×¨×™×”";
        if (total > 10) return "×¡×× ×›\"×œ";
        if (total > 5) return "×× ×”×œ ×× ×•×¡×”";
        return "×× ×›\"×œ ××ª×—×™×œ";
    }

    function clearAutoNext() {
        if (autoNextTimeout) {
            clearTimeout(autoNextTimeout);
            autoNextTimeout = null;
        }
    }

    // ×¤×ª×™×—×ª ×©×™×¢×•×¨ ××•×‘× ×”
    function openCategory(cat) {
        clearAutoNext();

        const idx = player.progress[cat];

        // ×× × ×’××¨×• ×”×©×™×¢×•×¨×™× ×‘×§×˜×’×•×¨×™×” â€“ ×§×•×¤×¦×™× ×™×©×¨ ×œ×¡×™××•×œ×¦×™×•×ª
        if (!DATABASE[cat][idx]) {
            generateRandomEvent(cat);
            return;
        }

        const lesson = DATABASE[cat][idx];
        showLessonUI(cat, lesson.t, lesson.c, lesson.q, lesson.o, lesson.a);
    }

    // ×™×¦×™×¨×ª ××™×¨×•×¢ ×¨× ×“×•××œ×™
    function generateRandomEvent(forcedCat = null) {
        clearAutoNext();

        const template = EVENTS_TEMPLATES[Math.floor(Math.random() * EVENTS_TEMPLATES.length)];
        const uiCat = forcedCat ? forcedCat : "general";

        showEventUI(uiCat, "ğŸ”¥ ××™×¨×•×¢ ×‘×–××Ÿ ×××ª!", template.text, template.opts, template.outcomes, forcedCat);
    }

    // ×”×¦×’×ª ×©×™×¢×•×¨
    function showLessonUI(cat, title, content, q, opts, correctIdx) {
        const area = document.getElementById('lessonArea');
        area.style.display = 'block';

        document.getElementById('lessonTag').innerText = getCatHebrew(cat);
        document.getElementById('lessonTag').style.backgroundColor = getCatColor(cat);
        document.getElementById('lessonTitle').innerText = title;
        document.getElementById('lessonContent').innerText = content;

        const feedback = document.getElementById('feedbackArea');
        feedback.style.display = 'none';
        feedback.className = 'feedback';

        const nextBtn = document.getElementById('nextBtn');
        nextBtn.style.display = 'none';

        const optsDiv = document.getElementById('optionsArea');
        optsDiv.innerHTML = "<p style=\"font-weight:bold;\">" + q + "</p>";

        opts.forEach((opt, i) => {
            const btn = document.createElement('div');
            btn.className = 'btn-option';
            btn.innerText = opt;
            btn.onclick = () => checkLessonAnswer(cat, i, correctIdx);
            optsDiv.appendChild(btn);
        });

        area.scrollIntoView({ behavior: "smooth" });
    }

    // ×‘×“×™×§×ª ×ª×©×•×‘×” ×‘×©×™×¢×•×¨
    function checkLessonAnswer(cat, selected, correct) {
        const feedback = document.getElementById('feedbackArea');
        feedback.style.display = 'block';

        if (selected === correct) {
            feedback.className = 'feedback f-good';
            feedback.innerText = "× ×›×•×Ÿ ×××•×“! +$500";

            player.money += 500;
            player.progress[cat]++;
            localStorage.setItem('ceoSimSave', JSON.stringify(player));
            updateUI();

            // × ×•×¢×œ ××ª ×”××¤×©×¨×•×™×•×ª
            document.getElementById('optionsArea').innerHTML = "";

            // ××—×¨×™ 3 ×©× ×™×•×ª â€“ ×œ×©×™×¢×•×¨ ×”×‘× / ×¡×™××•×œ×¦×™×”
            autoNextTimeout = setTimeout(function () {
                const idx = player.progress[cat];
                if (DATABASE[cat][idx]) {
                    openCategory(cat);
                } else {
                    generateRandomEvent(cat);
                }
            }, 3000);
        } else {
            feedback.className = 'feedback f-bad';
            feedback.innerText = "×˜×¢×•×ª. × ×¡×” ×©×•×‘.";
        }
    }

    // ×”×¦×’×ª ××™×¨×•×¢ (×¡×™××•×œ×¦×™×”)
    function showEventUI(cat, title, content, opts, outcomes, forcedCat) {
        const area = document.getElementById('lessonArea');
        area.style.display = 'block';

        document.getElementById('lessonTag').innerText = "×¡×™××•×œ×¦×™×”";
        document.getElementById('lessonTag').style.background = "linear-gradient(45deg, #6366f1, #8b5cf6)";
        document.getElementById('lessonTitle').innerText = title;
        document.getElementById('lessonContent').innerText = content;

        const feedback = document.getElementById('feedbackArea');
        feedback.style.display = 'none';
        feedback.className = 'feedback';

        const nextBtn = document.getElementById('nextBtn');
        nextBtn.style.display = 'none';

        const optsDiv = document.getElementById('optionsArea');
        optsDiv.innerHTML = "";

        opts.forEach((opt, i) => {
            const btn = document.createElement('div');
            btn.className = 'btn-option';
            btn.innerText = opt;
            // ××¢×‘×™×¨×™× ×’× ××ª ×”×§×˜×’×•×¨×™×” ×›×“×™ ×©× ×“×¢ ×œ×”××©×™×š ×‘×©×¨×©×¨×ª
            btn.onclick = () => resolveEvent(outcomes[i], forcedCat || null);
            optsDiv.appendChild(btn);
        });

        area.scrollIntoView({ behavior: "smooth" });
    }

    // ×˜×™×¤×•×œ ×‘×ª×•×¦××” ×©×œ ××™×¨×•×¢
    function resolveEvent(outcomeMoney, forcedCat) {
        clearAutoNext();

        const feedback = document.getElementById('feedbackArea');
        const optsDiv = document.getElementById('optionsArea');

        optsDiv.innerHTML = "";
        feedback.style.display = 'block';

        player.money += outcomeMoney;
        localStorage.setItem('ceoSimSave', JSON.stringify(player));
        updateUI();

        if (outcomeMoney > 0) {
            feedback.className = 'feedback f-good';
            feedback.innerText = "×”×—×œ×˜×” ×˜×•×‘×”! ×”×¨×•×•×—×ª $" + outcomeMoney;
        } else if (outcomeMoney < 0) {
            feedback.className = 'feedback f-bad';
            feedback.innerText = "×”×—×œ×˜×” ×›×•××‘×ª... ×”×¤×¡×“×ª $" + Math.abs(outcomeMoney);
        } else {
            feedback.className = 'feedback';
            feedback.style.border = '1px solid #ccc';
            feedback.innerText = "×”×—×œ×˜×” × ×™×™×˜×¨×œ×™×ª. ×”××¦×‘ × ×©××¨ ×™×¦×™×‘.";
        }

        // ××—×¨×™ 3 ×©× ×™×•×ª â€“ ××™×¨×•×¢ ×—×“×©
        autoNextTimeout = setTimeout(function () {
            generateRandomEvent(forcedCat || null);
        }, 3000);
    }

    function closeLesson() {
        clearAutoNext();
        document.getElementById('lessonArea').style.display = 'none';
    }

    // ×¢×–×¨×™×
    function getCatHebrew(cat) {
        if (cat == 'finance') return '×¤×™× × ×¡×™';
        if (cat == 'marketing') return '×©×™×•×•×§';
        if (cat == 'ops') return '×ª×¤×¢×•×œ';
        if (cat == 'hr') return '××©××‘×™ ×× ×•×©';
        return '×›×œ×œ×™';
    }

    function getCatColor(cat) {
        if (cat == 'finance') return 'var(--finance)';
        if (cat == 'marketing') return 'var(--marketing)';
        if (cat == 'ops') return 'var(--ops)';
        if (cat == 'hr') return 'var(--hr)';
        return '#ccc';
    }
</script>
